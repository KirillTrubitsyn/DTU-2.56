# Пошаговая инструкция по настройке n8n для проекта DTU

## Что такое n8n?

n8n (произносится "н-эйт-эн") — это бесплатный инструмент автоматизации с визуальным интерфейсом. Вместо написания кода вы соединяете блоки (ноды) линиями, создавая логику работы приложения.

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   [Webhook] ──▶ [Обработка] ──▶ [База данных] ──▶ [Ответ]      │
│                                                                 │
│   Каждый блок = одна операция                                   │
│   Линия = передача данных между блоками                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Часть 1: Установка n8n

### Вариант А: Docker (рекомендуется для начинающих)

**Шаг 1.** Установите Docker Desktop
- Windows/Mac: https://www.docker.com/products/docker-desktop
- Linux: `sudo apt install docker.io`

**Шаг 2.** Откройте терминал (командную строку) и выполните:

```bash
docker run -d \
  --name n8n \
  --restart always \
  -p 5678:5678 \
  -v n8n_data:/home/node/.n8n \
  n8nio/n8n
```

**Шаг 3.** Откройте браузер и перейдите на:
```
http://localhost:5678
```

**Шаг 4.** Создайте аккаунт (это локальный аккаунт, данные хранятся у вас)

---

### Вариант Б: npm (если нет Docker)

```bash
# Установите Node.js 18+ с https://nodejs.org

# Установите n8n глобально
npm install -g n8n

# Запустите
n8n start
```

---

### Вариант В: n8n Cloud (платный, но без установки)

1. Перейдите на https://n8n.io
2. Нажмите "Start Free Trial"
3. Создайте аккаунт
4. Получите готовый n8n в облаке

---

## Часть 2: Настройка учётных данных (Credentials)

Перед импортом workflow нужно настроить подключения к сервисам.

### 2.1 Настройка Google API Key

**Шаг 1.** Перейдите в Google AI Studio:
```
https://aistudio.google.com/app/apikey
```

**Шаг 2.** Нажмите "Create API Key"

**Шаг 3.** Скопируйте ключ (выглядит как `AIzaSy...`)

**Шаг 4.** В n8n:
1. Нажмите на иконку ⚙️ (Settings) в левом меню
2. Выберите "Credentials"
3. Нажмите "+ Add Credential"
4. Найдите "HTTP Query Auth"
5. Заполните:
   - **Name:** `Google API Key`
   - **Parameter Name:** `key`
   - **Parameter Value:** Вставьте ваш API ключ
6. Нажмите "Save"

```
┌──────────────────────────────────────┐
│          HTTP Query Auth              │
├──────────────────────────────────────┤
│ Name: Google API Key                  │
│                                       │
│ Parameter Name: key                   │
│ Parameter Value: AIzaSy...            │
│                                       │
│               [Save]                  │
└──────────────────────────────────────┘
```

---

### 2.2 Настройка Supabase

**Шаг 1.** Войдите в Supabase:
```
https://supabase.com/dashboard
```

**Шаг 2.** Выберите ваш проект DTU

**Шаг 3.** Перейдите в Settings → API

**Шаг 4.** Скопируйте:
- **Project URL** (например: `https://xxx.supabase.co`)
- **Service Role Key** (длинный ключ, начинается с `eyJ...`)

**Шаг 5.** В n8n:
1. Settings → Credentials → Add Credential
2. Найдите "Supabase"
3. Заполните:
   - **Name:** `Supabase`
   - **Host:** Вставьте Project URL
   - **Service Role Secret:** Вставьте Service Role Key
4. Нажмите "Save"

```
┌──────────────────────────────────────┐
│           Supabase API                │
├──────────────────────────────────────┤
│ Name: Supabase                        │
│                                       │
│ Host: https://xxx.supabase.co         │
│                                       │
│ Service Role Secret: eyJhbGc...       │
│                                       │
│               [Save]                  │
└──────────────────────────────────────┘
```

---

## Часть 3: Импорт Workflow

### 3.1 Импорт RAG Chat Workflow

**Шаг 1.** В n8n нажмите "Workflows" в левом меню

**Шаг 2.** Нажмите "+ Add Workflow"

**Шаг 3.** Нажмите на три точки (...) в правом верхнем углу

**Шаг 4.** Выберите "Import from File..."

**Шаг 5.** Выберите файл:
```
n8n-workflows/01-rag-chat-workflow.json
```

**Шаг 6.** После импорта вы увидите workflow:

```
┌─────────────────────────────────────────────────────────────────────┐
│                       DTU RAG Chat                                   │
│                                                                       │
│  ┌────────────┐   ┌──────────────┐   ┌─────────────────┐            │
│  │   Chat     │──▶│ Get Query    │──▶│ Vector Search   │            │
│  │  Webhook   │   │ Embedding    │   │   Supabase      │            │
│  └────────────┘   └──────────────┘   └────────┬────────┘            │
│                                               │                      │
│                                               ▼                      │
│  ┌────────────┐   ┌──────────────┐   ┌─────────────────┐            │
│  │ Respond to │◀──│    Parse     │◀──│  Gemini Chat    │            │
│  │   Chat     │   │   Response   │   │                 │◀───┐       │
│  └────────────┘   └──────────────┘   └─────────────────┘    │       │
│                                                              │       │
│                                      ┌─────────────────┐    │       │
│                                      │ Format Context  │────┘       │
│                                      └─────────────────┘            │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.2 Подключение Credentials к нодам

После импорта нужно подключить созданные credentials к каждой ноде.

**Для "Get Query Embedding" и "Gemini Chat":**

1. Нажмите на ноду (блок)
2. В правой панели найдите "Credential to connect with"
3. Выберите "Google API Key"

**Для "Vector Search Supabase":**

1. Нажмите на ноду
2. В правой панели выберите "Supabase"

```
┌─────────────────────────────────────┐
│      Get Query Embedding             │
├─────────────────────────────────────┤
│                                      │
│ Credential to connect with:          │
│ ┌──────────────────────────────┐    │
│ │ Google API Key           ▼  │    │
│ └──────────────────────────────┘    │
│                                      │
└─────────────────────────────────────┘
```

---

### 3.3 Активация Workflow

**Шаг 1.** Нажмите переключатель "Active" в правом верхнем углу

**Шаг 2.** Скопируйте URL webhook:
- Нажмите на ноду "Chat Webhook"
- В панели справа найдите "Webhook URLs"
- Скопируйте "Production URL"

```
Production URL:
https://your-n8n-instance.com/webhook/chat
                              ─────────────
                              Этот URL используйте во frontend
```

---

## Часть 4: Настройка Frontend

### 4.1 Обновление index.html

Найдите в `index.html` все обращения к API и замените на URL вашего n8n:

**Было (Vercel):**
```javascript
const response = await fetch('/api/chat', {
```

**Стало (n8n):**
```javascript
const response = await fetch('https://your-n8n.com/webhook/chat', {
```

### 4.2 Все URL для замены

| Старый URL | Новый URL (n8n) |
|------------|-----------------|
| `/api/chat` | `https://your-n8n.com/webhook/chat` |
| `/api/upload` | `https://your-n8n.com/webhook/upload` |
| `/api/recognize` | `https://your-n8n.com/webhook/recognize` |
| `/api/documents` | `https://your-n8n.com/webhook/documents` |

---

## Часть 5: Импорт остальных Workflow

Повторите шаги из части 3 для каждого файла:

1. **02-document-upload-workflow.json** — Загрузка документов
2. **03-ocr-workflow.json** — OCR распознавание
3. **04-documents-crud-workflow.json** — Управление документами

---

## Часть 6: Тестирование

### 6.1 Тест RAG Chat

**Через n8n (рекомендуется для отладки):**

1. Откройте workflow "DTU RAG Chat"
2. Нажмите "Test workflow" (кнопка воспроизведения)
3. Нажмите на ноду "Chat Webhook"
4. Введите тестовые данные:

```json
{
  "body": {
    "message": "Какие самые сильные аргументы защиты?",
    "history": []
  }
}
```

5. Нажмите "Test step"
6. Посмотрите как данные проходят через каждую ноду

**Через cURL:**

```bash
curl -X POST https://your-n8n.com/webhook/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Привет!", "history": []}'
```

---

### 6.2 Понимание визуализации

В n8n каждое выполнение сохраняется. Вы можете:

1. **Executions** (левое меню) — История всех запросов
2. Нажмите на любое выполнение
3. Увидите путь данных через workflow
4. Нажмите на любую ноду — увидите входные/выходные данные

```
┌─────────────────────────────────────────────────────────────────┐
│                    Execution #42                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [Webhook] ✓   →   [Embedding] ✓   →   [Search] ✓               │
│                                                                  │
│       │                  │                 │                     │
│       ▼                  ▼                 ▼                     │
│  ┌─────────┐       ┌──────────┐      ┌──────────┐               │
│  │ INPUT   │       │ INPUT    │      │ OUTPUT   │               │
│  │ message:│       │ vector:  │      │ docs: 5  │               │
│  │ "Привет"│       │ [0.1,...]│      │ sim: 0.8 │               │
│  └─────────┘       └──────────┘      └──────────┘               │
│                                                                  │
│  [Format] ✓   →   [Gemini] ✓   →   [Respond] ✓                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Часть 7: Решение проблем

### Ошибка "Could not find credential"

**Причина:** Credentials не подключены к ноде

**Решение:**
1. Нажмите на ноду с ошибкой
2. В панели справа найдите "Credential to connect with"
3. Выберите нужный credential

---

### Ошибка "401 Unauthorized" от Google API

**Причина:** Неверный API ключ

**Решение:**
1. Проверьте API ключ в Google AI Studio
2. Обновите credential в n8n
3. Убедитесь что API ключ активен

---

### Ошибка "relation 'documents' does not exist"

**Причина:** База данных не настроена

**Решение:**
1. Выполните SQL из файла `supabase/schema.sql` в Supabase
2. Убедитесь что таблица `documents` существует

---

### Webhook не отвечает

**Причина:** Workflow не активирован

**Решение:**
1. Откройте workflow
2. Включите переключатель "Active" справа вверху
3. Убедитесь что используете "Production URL", а не "Test URL"

---

## Часть 8: Архитектура после миграции

```
┌─────────────────────────────────────────────────────────────────────┐
│                         НОВАЯ АРХИТЕКТУРА                            │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                    FRONTEND (index.html)                        ││
│  │                    Хостинг: Vercel / Netlify / VPS              ││
│  └───────────────────────────┬─────────────────────────────────────┘│
│                              │                                       │
│                              ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                         n8n                                      ││
│  │                    (Self-hosted / Cloud)                         ││
│  │                                                                   ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  ││
│  │  │  RAG Chat    │  │   Upload     │  │   OCR Recognition    │  ││
│  │  │  Workflow    │  │   Workflow   │  │      Workflow        │  ││
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘  ││
│  │                                                                   ││
│  │  ┌──────────────────────────────────────────────────────────┐  ││
│  │  │              Documents CRUD Workflow                      │  ││
│  │  └──────────────────────────────────────────────────────────┘  ││
│  └───────────────────────────┬─────────────────────────────────────┘│
│                              │                                       │
│              ┌───────────────┼───────────────┐                      │
│              ▼               ▼               ▼                      │
│  ┌──────────────────┐  ┌───────────────┐  ┌───────────────────┐    │
│  │   Google Gemini  │  │   Supabase    │  │  (Опционально)    │    │
│  │   • Chat         │  │   PostgreSQL  │  │  Другие сервисы   │    │
│  │   • Embeddings   │  │   + pgvector  │  │  • Slack          │    │
│  │   • OCR          │  │               │  │  • Telegram       │    │
│  └──────────────────┘  └───────────────┘  │  • Email          │    │
│                                            └───────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Часть 9: Дополнительные возможности n8n

После миграции вы можете легко добавить:

### 9.1 Уведомления в Telegram

```
[Chat Webhook] → [Gemini] → [Telegram] → [Respond]
                              │
                              └── Отправить копию ответа в Telegram
```

### 9.2 Логирование в Google Sheets

```
[Any Workflow] → [Google Sheets]
                      │
                      └── Записать каждый запрос в таблицу
```

### 9.3 Расписание для обновления

```
[Schedule Trigger] → [Check Updates] → [Upload New Docs]
      │
      └── Каждый день в 9:00 проверять новые документы
```

---

## Глоссарий

| Термин | Объяснение |
|--------|------------|
| **Workflow** | Последовательность действий (как программа) |
| **Node (Нода)** | Один блок/операция в workflow |
| **Trigger** | Нода, которая запускает workflow (Webhook, Schedule) |
| **Credential** | Сохранённые данные для подключения (ключи, пароли) |
| **Webhook** | URL, на который можно отправить HTTP-запрос |
| **Execution** | Одно выполнение workflow |

---

## Полезные ссылки

- **Документация n8n:** https://docs.n8n.io
- **Сообщество n8n:** https://community.n8n.io
- **Видеоуроки:** https://www.youtube.com/@n8n-io
- **Google AI Studio:** https://aistudio.google.com
- **Supabase Docs:** https://supabase.com/docs

---

## Контрольный список

- [ ] Установлен n8n (Docker/npm/Cloud)
- [ ] Создан Google API Key credential
- [ ] Создан Supabase credential
- [ ] Импортирован 01-rag-chat-workflow.json
- [ ] Импортирован 02-document-upload-workflow.json
- [ ] Импортирован 03-ocr-workflow.json
- [ ] Импортирован 04-documents-crud-workflow.json
- [ ] Подключены credentials ко всем нодам
- [ ] Активированы все workflow
- [ ] Обновлены URL в index.html
- [ ] Протестирован чат
- [ ] Протестирована загрузка документов

---

**Поздравляем!** Вы успешно перенесли проект в n8n!
