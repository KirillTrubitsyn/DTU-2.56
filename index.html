<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>АО «Дальтрансуголь» — Анализ линий защиты</title>

    <!-- Favicon и иконки -->
    <link rel="icon" type="image/x-icon" href="favicon-32.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- PWA манифест -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA мета-теги -->
    <meta name="theme-color" content="#1a365d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Дальтрансуголь">
    <meta name="application-name" content="Дальтрансуголь">
    <meta name="msapplication-TileColor" content="#1a365d">
    <meta name="msapplication-TileImage" content="icon-192.png">

    <!-- PDF.js для рендеринга PDF страниц -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mammoth.js для чтения DOCX файлов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent-gold: #d69e2e;
            --strong: #38a169;
            --strong-light: #c6f6d5;
            --medium: #d69e2e;
            --medium-light: #fefcbf;
            --weak: #e53e3e;
            --weak-light: #fed7d7;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-muted: #718096;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: pulse 15s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .header .case-number {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .header .claim-amount {
            display: inline-block;
            background: var(--accent-gold);
            color: var(--primary);
            padding: 0.5rem 1.5rem;
            border-radius: 2rem;
            font-weight: 700;
            margin-top: 1rem;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: transform 0.2s;
        }

        .legend-item:hover {
            transform: scale(1.05);
        }

        .legend-item.strong {
            background: var(--strong-light);
            color: var(--strong);
            border: 2px solid var(--strong);
        }

        .legend-item.medium {
            background: var(--medium-light);
            color: #744210;
            border: 2px solid var(--medium);
        }

        .legend-item.weak {
            background: var(--weak-light);
            color: var(--weak);
            border: 2px solid var(--weak);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-item.strong .legend-dot { background: var(--strong); }
        .legend-item.medium .legend-dot { background: var(--medium); }
        .legend-item.weak .legend-dot { background: var(--weak); }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }

        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .card.strong { border-left-color: var(--strong); }
        .card.medium { border-left-color: var(--medium); }
        .card.weak { border-left-color: var(--weak); }

        .card-header {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            user-select: none;
        }

        .card.strong .card-header { background: linear-gradient(90deg, var(--strong-light) 0%, transparent 100%); }
        .card.medium .card-header { background: linear-gradient(90deg, var(--medium-light) 0%, transparent 100%); }
        .card.weak .card-header { background: linear-gradient(90deg, var(--weak-light) 0%, transparent 100%); }

        .card-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            flex-shrink: 0;
        }

        .card.strong .card-number { background: var(--strong); }
        .card.medium .card-number { background: var(--medium); }
        .card.weak .card-number { background: var(--weak); }

        .card-title-area {
            flex: 1;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .card-badges {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-strength {
            background: var(--primary);
            color: white;
        }

        .badge-court {
            background: var(--border);
            color: var(--text-muted);
        }

        .badge-court.yes { background: #bee3f8; color: #2b6cb0; }
        .badge-court.no { background: #e2e8f0; color: #718096; }
        .badge-court.partial { background: #fefcbf; color: #744210; }

        .expand-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.3s;
            color: var(--text-muted);
        }

        .card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .card.expanded .card-content {
            max-height: 2000px;
        }

        .card-body {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .info-section {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }

        .info-section h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-section h4::before {
            content: '';
            width: 4px;
            height: 16px;
            border-radius: 2px;
        }

        .info-section.rpn h4::before { background: #e53e3e; }
        .info-section.court h4::before { background: #3182ce; }
        .info-section.rec h4::before { background: #38a169; }
        .info-section.arg h4::before { background: #805ad5; }

        .info-section ul {
            list-style: none;
            padding: 0;
        }

        .info-section li {
            padding: 0.5rem 0;
            padding-left: 1.25rem;
            position: relative;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
        }

        .info-section li:last-child {
            border-bottom: none;
        }

        .info-section li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--text-muted);
        }

        .info-section p {
            font-size: 0.9rem;
            color: var(--text);
        }

        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fef3c7 100%);
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }

        .court-decision {
            background: #ebf8ff;
            border-left: 3px solid #3182ce;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.85rem;
        }

        .court-decision .date {
            font-weight: 600;
            color: #2b6cb0;
        }

        .abandon-banner {
            background: linear-gradient(90deg, var(--weak-light) 0%, #fff 100%);
            border: 2px dashed var(--weak);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .abandon-banner strong {
            color: var(--weak);
        }

        .strategy-section {
            margin-top: 3rem;
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .strategy-section h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .strategy-card {
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            transition: transform 0.3s;
        }

        .strategy-card:hover {
            transform: scale(1.02);
        }

        .strategy-card.priority {
            background: linear-gradient(135deg, var(--strong-light) 0%, #9ae6b4 100%);
            border: 2px solid var(--strong);
        }

        .strategy-card.support {
            background: linear-gradient(135deg, var(--medium-light) 0%, #fbd38d 100%);
            border: 2px solid var(--medium);
        }

        .strategy-card.abandon {
            background: linear-gradient(135deg, var(--weak-light) 0%, #fc8181 100%);
            border: 2px solid var(--weak);
        }

        .strategy-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        .strategy-card.priority h3 { color: #276749; }
        .strategy-card.support h3 { color: #744210; }
        .strategy-card.abandon h3 { color: #c53030; }

        .strategy-card p {
            font-size: 0.9rem;
            color: var(--text);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .card.strong .progress-bar .fill { background: var(--strong); }
        .card.medium .progress-bar .fill { background: var(--medium); }
        .card.weak .progress-bar .fill { background: var(--weak); }

        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-muted);
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.3rem; }
            .card-header { flex-wrap: wrap; }
            .card-badges { width: 100%; margin-top: 0.5rem; }
            .info-grid { grid-template-columns: 1fr; }
            .strategy-grid { grid-template-columns: 1fr; }
        }

        /* AI Chat Styles */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(26, 54, 93, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(26, 54, 93, 0.5);
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .chat-fab .badge-notify {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-gold);
            color: var(--primary);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .chat-modal {
            display: none;
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 600px;
            max-width: calc(100vw - 2rem);
            height: 700px;
            max-height: calc(100vh - 8rem);
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
            animation: slideUp 0.3s ease;
        }

        .chat-modal.open {
            display: flex;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-icon svg {
            width: 22px;
            height: 22px;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .chat-header-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Chat tabs */
        .chat-tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .chat-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .chat-tab:hover {
            color: var(--text);
            background: var(--bg);
        }
        .chat-tab.active {
            color: var(--primary);
        }
        .chat-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        .chat-tab-badge {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* Tab content */
        .chat-tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .chat-tab-content.active {
            display: flex;
        }

        /* Saved tab view */
        .saved-tab-view {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg);
        }
        .saved-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }
        .saved-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        .saved-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .saved-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .saved-card-actions {
            display: flex;
            gap: 0.5rem;
        }
        .saved-card-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .saved-card-btn:hover {
            color: var(--primary);
        }
        .saved-card-btn.delete:hover {
            color: var(--danger);
        }
        .saved-card-content {
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 150px;
            overflow: hidden;
            position: relative;
        }
        .saved-card-content.expanded {
            max-height: none;
        }
        .saved-card-expand {
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem 0 0 0;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg);
        }

        .chat-message {
            max-width: 85%;
            padding: 0.875rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            align-self: flex-start;
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant .sources {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chat-message.assistant .sources strong {
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .chat-message.assistant .sources.no-sources {
            background: #fef3c7;
            color: #92400e;
        }

        .chat-message.assistant .sources ul {
            margin: 0;
            padding-left: 1.25rem;
            list-style: disc;
        }

        .chat-message.assistant .sources li {
            margin: 0.125rem 0;
        }

        .chat-message.typing {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
        }

        .chat-message.typing span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .chat-message.typing span:nth-child(1) { animation-delay: -0.32s; }
        .chat-message.typing span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input-area {
            padding: 1rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 1.5rem;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .chat-send:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .chat-send svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .chat-welcome {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
        }

        .chat-welcome h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .chat-welcome p {
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .chat-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-suggestion {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chat-suggestion:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .chat-error {
            background: var(--weak-light);
            color: var(--weak);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            margin: 0.5rem 1rem;
        }

        /* Tablet styles */
        @media (max-width: 1024px) {
            .chat-modal {
                width: 500px;
                height: 650px;
            }
        }

        /* Mobile styles - fullscreen chat */
        @media (max-width: 768px) {
            .chat-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
                z-index: 9999;
            }
            .chat-fab {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 56px;
                height: 56px;
            }
            .chat-header {
                padding: 1rem;
            }
            .chat-tabs {
                padding: 0;
            }
            .chat-tab {
                padding: 1rem;
                font-size: 0.9rem;
            }
            .chat-messages {
                padding: 0.75rem;
            }
            .chat-input-area {
                padding: 0.75rem;
                padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            }
            .chat-input {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            .saved-tab-view {
                padding: 0.75rem;
            }
            .saved-card {
                padding: 0.75rem;
            }
            .admin-fab {
                bottom: 1rem;
                right: 5rem;
            }
        }

        /* Admin Panel Styles */
        .admin-fab {
            position: fixed;
            bottom: 2rem;
            right: 7rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(113, 128, 150, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .admin-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(113, 128, 150, 0.5);
        }

        .admin-fab svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .admin-modal.open {
            display: flex;
        }

        .admin-panel {
            background: var(--card-bg);
            border-radius: 1rem;
            width: 500px;
            max-width: calc(100vw - 2rem);
            max-height: calc(100vh - 4rem);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        .admin-header {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .admin-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .admin-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .admin-close:hover {
            opacity: 1;
        }

        .admin-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 12rem);
        }

        .admin-form-group {
            margin-bottom: 1.25rem;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }

        .admin-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .admin-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .admin-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .admin-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        .admin-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        .admin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .admin-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .admin-message.success {
            background: var(--strong-light);
            color: var(--strong);
        }

        .admin-message.error {
            background: var(--weak-light);
            color: var(--weak);
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .admin-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-tab:hover {
            color: var(--primary);
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Document Stats */
        .doc-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .doc-stats-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .doc-stats-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Category Filter */
        .doc-filter {
            margin-bottom: 1rem;
        }

        .doc-filter select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            background: white;
        }

        /* Document List */
        .doc-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .doc-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            transition: all 0.2s;
        }

        .doc-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .doc-item-info {
            flex: 1;
            min-width: 0;
        }

        .doc-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doc-item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .doc-item-category {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: var(--bg);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .doc-item-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .doc-item-btn {
            padding: 0.375rem;
            background: none;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .doc-item-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .doc-item-btn.delete:hover {
            border-color: var(--weak);
            color: var(--weak);
        }

        .doc-item-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Loading state */
        .doc-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .doc-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Pagination */
        .doc-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .doc-pagination button {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .doc-pagination button:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .doc-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .doc-pagination span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Edit Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .edit-modal.open {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .edit-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .admin-login-form {
            text-align: center;
        }

        .admin-login-form svg {
            width: 48px;
            height: 48px;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .admin-login-form p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* File Upload / Drop Zone Styles */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg);
            margin-bottom: 1.25rem;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.05);
        }

        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.1);
            transform: scale(1.02);
        }

        .drop-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .drop-zone-text {
            color: var(--text);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .drop-zone-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .camera-btn {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .camera-btn:hover {
            background: var(--primary-light);
        }

        @media (max-width: 768px) {
            .camera-btn {
                display: inline-flex;
            }
        }

        .drop-zone input[type="file"] {
            display: none;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
        }

        .processing-indicator .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .file-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .file-preview-info {
            flex: 1;
            min-width: 0;
        }

        .file-preview-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-preview-size {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .file-preview-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .file-preview-remove:hover {
            color: var(--weak);
        }

        .admin-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.25rem 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .admin-divider::before,
        .admin-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Markdown styling in chat */
        .chat-message h3 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0.75rem 0 0.5rem 0;
            color: var(--primary);
        }
        .chat-message h3:first-child {
            margin-top: 0;
        }
        .chat-message ul, .chat-message ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        .chat-message li {
            margin: 0.25rem 0;
        }
        .chat-message p {
            margin: 0.5rem 0;
        }
        .chat-message p:first-child {
            margin-top: 0;
        }

        /* Formula styling */
        .chat-message .formula {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin: 0.75rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .chat-message .formula-inline {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            padding: 0.15rem 0.4rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* Save button */
        .chat-message-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        .chat-message-wrapper.user {
            align-items: flex-end;
        }
        .save-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }
        .chat-message-wrapper:hover .save-btn {
            opacity: 1;
        }
        .save-btn:hover {
            background: var(--bg);
            color: var(--primary);
        }
        .save-btn.saved {
            opacity: 1;
            color: var(--success);
        }

    </style>
</head>
<body>
    <header class="header">
        <h1>АО «ДАЛЬТРАНСУГОЛЬ»</h1>
        <p class="case-number">Дело № А73-19604/2025 • Анализ линий защиты</p>
        <div class="claim-amount">Цена иска: 2 562 113 054,91 ₽</div>
    </header>

    <div class="container">
        <div class="legend">
            <div class="legend-item strong">
                <span class="legend-dot"></span>
                Сильный (8-10)
            </div>
            <div class="legend-item medium">
                <span class="legend-dot"></span>
                Средний (4-7)
            </div>
            <div class="legend-item weak">
                <span class="legend-dot"></span>
                Отказаться (1-3)
            </div>
        </div>

        <!-- Card 1: Constitutional Court -->
        <div class="card strong" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">1</div>
                <div class="card-title-area">
                    <div class="card-title">Позиция Конституционного Суда РФ</div>
                    <div class="card-subtitle">Постановление № 56-П от 06.12.2024</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">9/10</span>
                    <span class="badge badge-court no">Не заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 90%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Суд <strong>не вправе</strong> ограничиваться установлением элементов состава правонарушения. <span class="highlight">Обязан учитывать обстоятельства, исключающие или уменьшающие вред.</span> Формальное применение методик расчёта <strong>недопустимо</strong>. Требуется оценка фактических неблагоприятных экологических последствий.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Вероятная позиция Росприроднадзора</h4>
                            <ul>
                                <li>КС рассматривал конкретное дело, не аналогичное настоящему</li>
                                <li>Методика 87 утверждена Минприроды и подлежит обязательному применению</li>
                                <li>Суды правильно применили методику в соответствии с законом</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов</h4>
                            <p><strong>Не рассматривалось.</strong> Постановление КС вынесено 06.12.2024 — после завершения всех административных дел и решений арбитражных судов по делу А73-8310/2024 (АС ДВО 09.07.2025).</p>
                            <p style="margin-top: 0.75rem; color: var(--strong); font-weight: 600;">Данный аргумент в судах ещё не заявлялся.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <ul>
                                <li>Представить практику применения КС 56-П:</li>
                                <li><strong>АС ЗСО от 25.12.2024</strong></li>
                                <li><strong>АС ПО от 28.02.2025</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: No Real Damage -->
        <div class="card strong" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">2</div>
                <div class="card-title-area">
                    <div class="card-title">Отсутствие реального экологического вреда</div>
                    <div class="card-subtitle">Мониторинг ДВФУ 2008-2024 (16 лет)</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">8/10</span>
                    <span class="badge badge-court partial">Частично</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 80%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Данные мониторинга ДВФУ за <strong>16 лет</strong> показывают: здоровый бентос, нормальная фито/зоопланктон, ихтиофауна в норме. Видеосъёмка 2023: высокая продуктивность, отсутствие заиления. Заключение Галышевой: <span class="highlight">«Деятельность терминала НЕ оказывает негативного воздействия на экосистему бухты»</span>. Промысловые виды в норме, «подводные леса» 70-98% покрытия.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Прямая позиция в материалах отсутствует</li>
                                <li>Акцент на формальном нарушении ст. 56 ВК РФ (запрет сброса отходов)</li>
                                <li>Факт загрязнения подтверждён актами, протоколами, фото</li>
                                <li>Наличие последствий не является обязательным элементом состава</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка)</h4>
                            <p><strong>Не исследовалось по существу.</strong></p>
                            <div class="court-decision">
                                <span class="date">СОЮ (15.06.2023, 09.11.2023, 16.11.2023):</span> фокус на факте нарушения, а не на последствиях.
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский суд 16.10.2025:</span> довод о благополучии флоры/фауны отклонён как «несущественный для квалификации».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ХК, 6 ААС, АС ДВО по делу ВТУ:</span> экологические данные детально не анализировались.
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p><strong>Ходатайство о назначении судебной экологической экспертизы</strong> в арбитражном процессе для объективной оценки фактического состояния экосистемы.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 3: Investment Offset -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">3</div>
                <div class="card-title-area">
                    <div class="card-title">Зачёт экологических инвестиций</div>
                    <div class="card-subtitle">Инвестиции с 2023: 2 047 545 642 ₽</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">6/10</span>
                    <span class="badge badge-court no">Не заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 60%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Ветрозащитные экраны (25м × 2400м), системы пылеподавления, станция СКАТ. По <strong>п.14 Методики 87</strong> затраты на предотвращение сверхнормативного воздействия вычитаются из суммы вреда. Общий принцип: п.11 ст.16.3 ФЗ-7.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Вероятная позиция Росприроднадзора</h4>
                            <ul>
                                <li>П.14 Методики 87 — только для сбросов сточных вод (п.11), не для захламления (п.16)</li>
                                <li>Пылеподавление = обычная производственная деятельность, не компенсация вреда</li>
                                <li>Инвестиции сделаны ПОСЛЕ причинения вреда</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов</h4>
                            <p><strong>Не рассматривалось.</strong> Довод не заявлялся ни в административных делах СОЮ, ни в арбитражном деле А73-8310/2024.</p>
                            <p style="margin-top: 0.75rem;">Судебная практика по применению п.14 к п.16 Методики 87 отсутствует.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве изложено полно)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 4: Methodology Dispute -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">4</div>
                <div class="card-title-area">
                    <div class="card-title">Оспаривание методики расчёта</div>
                    <div class="card-subtitle">Коэффициент Кзагр: 6 → 1</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">5/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 50%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Кзагр=6 применяется при скоплении отходов >10 м² на 100 м² водной площади. Угольная пыль = <strong>диффузное</strong>, не очаговое загрязнение. Космоснимки: большая часть акватории НЕ покрыта. Корректный Кзагр=1 (снижение в 6 раз). П.16 Методики 87 для бытовых отходов, не пыли.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Загрязнение носит «площадной характер», простирается вглубь водного объекта</li>
                                <li>Площадь 14 589,94 м² подтверждена экспертным заключением ФГБУ ТОтехмордирекция (приёмник PrinCe i50)</li>
                                <li>Взвешенные вещества в пробах воды = проникновение пыли в толщу воды</li>
                                <li>Площадь >0,01 м² исключает Кзагр=1 по Таблице 10</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">АС ХК 15.01.2025:</span> «Площадь скопления мусора превышает 0,01 кв.м., что исключает применение коэффициента 1».
                            </div>
                            <div class="court-decision">
                                <span class="date">6 ААС 08.04.2025:</span> «Кзагр=6 обоснован тем, что загрязнение носит площадной характер».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ДВО 09.07.2025:</span> космоснимок отклонён — «невозможно достоверно установить состояние покрова 04.03, тогда как осмотр был 03.03.2023».
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: расчёт по п.17, моделирование ИСП РАН)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 5: Emission Standards -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">5</div>
                <div class="card-title-area">
                    <div class="card-title">Соблюдение нормативов выбросов</div>
                    <div class="card-subtitle">Концентрации в 10× ниже ПДК</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">5/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 50%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Проверка РПН: превышений нормативов выбросов угольной пыли НЕ установлено. Пробы воздуха: <strong>0,023-0,033 мг/м³</strong> при ПДК 0,3 мг/м³. ДТУ платит за НВОС по выбросам угольной пыли. Осаждение пыли = естественный физический процесс.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Плата НВОС = плата за атмосферные выбросы, НЕ за загрязнение воды</li>
                                <li>Ст.16 ФЗ-7: разные виды негативного воздействия</li>
                                <li>Соблюдение нормативов выбросов не освобождает от ответственности за захламление водного объекта отходами</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">Кировский суд 16.10.2025:</span> «Доводы о том, что уголь не является загрязнителем и отсутствует в перечне отходов, выбросы являются естественным процессом пыления — <strong>несостоятельны</strong>».
                            </div>
                            <p style="margin-top: 0.75rem;">Суд разграничил воздействие на атмосферу и воду как самостоятельные правонарушения.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: довод о двойном взыскании)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 6: Legal Qualification -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">6</div>
                <div class="card-title-area">
                    <div class="card-title">Правовая квалификация угольной пыли</div>
                    <div class="card-subtitle">Выброс ≠ отход</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">4/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 40%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Угольная пыль в Перечне загрязняющих веществ п.37(1) для воздуха, не в ФККО как самостоятельный отход. Код 6 19 111 13 71 4 — для дробления на ТЭС/ТЭЦ, не угольных терминалов.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Ст.1 ФЗ-89: отходы = вещества, подлежащие удалению</li>
                                <li>ГОСТ 30772-2001 п.3.11: отходы = остатки, не используемые в деятельности</li>
                                <li>Приказ РПН 242: мусор при дроблении угля (код 6 19 111 13 71 4)</li>
                                <li>Распоряжение 1316-р п.166: взвешенные вещества = загрязнители воды</li>
                                <li>Морфология: угольно-песчаная смесь 99,5±29,8%, пенопласт 0,5±0,2%</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">АС ХК 06.06.2024:</span> «Угольная пыль в силу ст.1 ФЗ-89 относится к отходам производства, подлежащим удалению».
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский 23.05.2025:</span> «Угольная пыль является отходом по ФККО, V класс опасности».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ДВО 27.11.2024:</span> «Довод о том, что собранные просыпи возвращаются в техпроцесс, оставлен без оценки».
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: экспертизы МГУ, УралНИИЭкология)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 7: Procedural Violations -->
        <div class="card weak" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">7</div>
                <div class="card-title-area">
                    <div class="card-title">Процедурные нарушения проверки</div>
                    <div class="card-subtitle">Согласование с ненадлежащей прокуратурой</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">2/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 20%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Проверка согласована с Амурским бассейновым природоохранным прокурором, полномочия которого НЕ распространяются на Ванинский и Советско-Гаванский районы (Распоряжение ГП РФ от 13.06.2018 № 360/7р).</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Распоряжение ГП РФ от 16.05.2016 № 288/7р: Амурская прокуратура осуществляет надзор за ДВМУ РПН</li>
                                <li>Согласование допустимо по месту нахождения контрольного органа</li>
                                <li>Информ. письмо ГП от 09.10.2023 критикует прокурора, но НЕ отменяет результаты проверки ДТУ</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">Советско-Гаванский суд 15.06.2023, 09.11.2023, 16.11.2023:</span> «Согласование по месту нахождения надзорного органа допустимо».
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский 23.05.2025, 16.10.2025:</span> «Информ. письмо ГП не содержит указания на незаконность проверки ДТУ».
                            </div>
                            <div class="court-decision">
                                <span class="date">Хабаровский краевой суд 27.08.2025:</span> позиция нижестоящих судов подтверждена.
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Рекомендация</h4>
                            <div class="abandon-banner">
                                <strong>✗ ОТКАЗАТЬСЯ ОТ АРГУМЕНТА</strong>
                                <p>Исчерпан во всех инстанциях. Не влияет на существо спора.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Section -->
        <div class="strategy-section">
            <h2>Итоговая стратегия</h2>
            <div class="strategy-grid">
                <div class="strategy-card priority">
                    <h3>★ ПРИОРИТЕТ</h3>
                    <p><strong>Линии 1-2:</strong> КС 56-П + данные ДВФУ = доказать отсутствие реального вреда</p>
                </div>
                <div class="strategy-card support">
                    <h3>● ПОДДЕРЖКА</h3>
                    <p><strong>Линии 3-6:</strong> Зачёт инвестиций, методика, квалификация — аргументы изложены в отзыве</p>
                </div>
                <div class="strategy-card abandon">
                    <h3>✗ ОТКАЗАТЬСЯ</h3>
                    <p><strong>Линия 7:</strong> Процедурные нарушения — многократно отклонены всеми инстанциями</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Дело № А73-19604/2025 • АО «Дальтрансуголь» • Приамурское МУ Росприроднадзора</p>
        <p style="margin-top: 0.5rem;">Потенциальное снижение: до полного отказа (линии 1-2) | минус 2 047 545 642 ₽ (линия 3)</p>
    </footer>

    <!-- Admin Button -->
    <button class="admin-fab" onclick="toggleAdmin()" aria-label="Панель администратора">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
    </button>

    <!-- Admin Modal -->
    <div class="admin-modal" id="adminModal" onclick="closeAdminOnBackdrop(event)">
        <div class="admin-panel" onclick="event.stopPropagation()">
            <div class="admin-header">
                <h2 id="adminTitle">Вход администратора</h2>
                <button class="admin-close" onclick="toggleAdmin()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-body">
                <div id="adminMessage"></div>

                <!-- Login Form -->
                <div id="adminLoginForm" class="admin-login-form">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <p>Введите пароль для доступа к загрузке документов</p>
                    <div class="admin-form-group">
                        <input type="password" class="admin-input" id="adminPassword" placeholder="Пароль" onkeypress="handleAdminKeyPress(event)">
                    </div>
                    <button class="admin-btn" onclick="adminLogin()">Войти</button>
                </div>

                <!-- Admin Content (hidden by default) -->
                <div id="adminUploadForm" style="display: none;">
                    <!-- Admin Tabs -->
                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="switchAdminTab('upload')" id="adminTabUpload">
                            Загрузка
                        </button>
                        <button class="admin-tab" onclick="switchAdminTab('documents')" id="adminTabDocuments">
                            База знаний <span id="docCountBadge" style="background: var(--primary); color: white; padding: 0.125rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                        </button>
                    </div>

                    <!-- Upload Tab Content -->
                    <div class="admin-tab-content active" id="adminUploadTabContent">
                        <!-- Drop Zone for OCR -->
                        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept="image/*,.pdf,.md,.txt,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleFileSelect(event)">
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)" style="display:none">
                            <div id="dropZoneContent">
                                <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <div class="drop-zone-text">Перетащите файл или нажмите для выбора</div>
                                <div class="drop-zone-hint">PDF, DOCX, изображения, Markdown, TXT</div>
                                <button type="button" class="camera-btn" id="cameraBtn" onclick="event.stopPropagation(); document.getElementById('cameraInput').click()">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                        <circle cx="12" cy="13" r="4"/>
                                    </svg>
                                    Сделать фото
                                </button>
                            </div>
                            <div id="processingIndicator" class="processing-indicator" style="display: none;">
                                <div class="spinner"></div>
                                <span id="processingText">ИИ распознаёт документ...</span>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="file-preview" style="display: none;">
                            <img id="previewImage" src="" alt="Preview">
                            <div class="file-preview-info">
                                <div class="file-preview-name" id="previewName"></div>
                                <div class="file-preview-size" id="previewSize"></div>
                            </div>
                            <button class="file-preview-remove" onclick="clearFile()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div class="admin-divider">или заполните вручную</div>

                        <div class="admin-form-group">
                            <label>Название документа *</label>
                            <input type="text" class="admin-input" id="docTitle" placeholder="Например: Договор поставки №123">
                        </div>
                        <div class="admin-form-group">
                            <label>Содержимое документа *</label>
                            <textarea class="admin-textarea" id="docContent" placeholder="Вставьте текст документа или загрузите файл для OCR..."></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label>Источник</label>
                            <input type="text" class="admin-input" id="docSource" placeholder="Например: Приложение к делу №5">
                        </div>
                        <div class="admin-form-group">
                            <label>Категория</label>
                            <select class="admin-select" id="docCategory">
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт (решение, определение)</option>
                                <option value="процессуальный_документ">Процессуальный документ (иск, отзыв, ходатайство)</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                        </div>
                        <button class="admin-btn" id="uploadBtn" onclick="uploadDocument()">Загрузить документ в базу знаний</button>
                    </div>

                    <!-- Documents Tab Content -->
                    <div class="admin-tab-content" id="adminDocsTabContent">
                        <!-- Stats -->
                        <div class="doc-stats">
                            <div>
                                <div class="doc-stats-total" id="totalDocsCount">0</div>
                                <div class="doc-stats-label">документов в базе</div>
                            </div>
                        </div>

                        <!-- Category Filter -->
                        <div class="doc-filter" style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="docFilterCategory" onchange="loadDocuments()" style="flex: 1;">
                                <option value="all">Все категории</option>
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт</option>
                                <option value="процессуальный_документ">Процессуальный документ</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                            <button onclick="deleteAllDocuments()" style="background: #e53e3e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; white-space: nowrap;">Удалить все</button>
                        </div>

                        <!-- Document List -->
                        <div class="doc-list" id="docList">
                            <div class="doc-loading">Загрузка документов...</div>
                        </div>

                        <!-- Pagination -->
                        <div class="doc-pagination" id="docPagination" style="display: none;">
                            <button onclick="changePage(-1)" id="prevPageBtn">← Назад</button>
                            <span id="pageInfo">1 / 1</span>
                            <button onclick="changePage(1)" id="nextPageBtn">Вперёд →</button>
                        </div>
                    </div>

                    <button class="admin-btn" style="margin-top: 0.75rem; background: linear-gradient(135deg, #718096 0%, #4a5568 100%);" onclick="adminLogout()">Выйти</button>
                </div>

                <!-- Edit Document Modal -->
                <div class="edit-modal" id="editModal" onclick="closeEditModal(event)">
                    <div class="edit-modal-content" onclick="event.stopPropagation()">
                        <div class="edit-modal-header">
                            <h3>Редактирование документа</h3>
                            <button class="admin-close" onclick="closeEditModal()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <input type="hidden" id="editDocId">
                        <div class="admin-form-group">
                            <label>Название</label>
                            <input type="text" class="admin-input" id="editDocTitle">
                        </div>
                        <div class="admin-form-group">
                            <label>Содержимое</label>
                            <textarea class="admin-textarea" id="editDocContent" style="min-height: 200px;"></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label>Источник</label>
                            <input type="text" class="admin-input" id="editDocSource">
                        </div>
                        <div class="admin-form-group">
                            <label>Категория</label>
                            <select class="admin-select" id="editDocCategory">
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт</option>
                                <option value="процессуальный_документ">Процессуальный документ</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                        </div>
                        <button class="admin-btn" onclick="saveDocument()">Сохранить изменения</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Button -->
    <button class="chat-fab" onclick="toggleChat()" aria-label="Открыть чат с ИИ">
        <span class="badge-notify">AI</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
    </button>

    <!-- AI Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <div class="chat-header-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </div>
            <div class="chat-header-info">
                <div class="chat-header-title">Юридический ИИ-помощник</div>
                <div class="chat-header-subtitle">Дело № А73-19604/2025</div>
            </div>
            <button class="chat-close" onclick="toggleChat()" aria-label="Закрыть чат">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Chat Tabs -->
        <div class="chat-tabs">
            <button class="chat-tab active" onclick="switchTab('chat')" id="tabChat">
                💬 Чат
            </button>
            <button class="chat-tab" onclick="switchTab('saved')" id="tabSaved">
                💾 Сохранённые <span class="chat-tab-badge" id="savedBadge" style="display: none;">0</span>
            </button>
        </div>

        <!-- Chat Tab Content -->
        <div class="chat-tab-content active" id="chatTabContent">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome">
                    <h3>Добро пожаловать!</h3>
                    <p>Я помогу разобраться в материалах дела АО «Дальтрансуголь». Задайте вопрос или выберите тему:</p>
                    <div class="chat-suggestions">
                        <button class="chat-suggestion" onclick="askQuestion('Какие самые сильные аргументы защиты?')">
                            Какие самые сильные аргументы защиты?
                        </button>
                        <button class="chat-suggestion" onclick="askQuestion('Расскажи про постановление КС РФ 56-П')">
                            Расскажи про постановление КС РФ 56-П
                        </button>
                        <button class="chat-suggestion" onclick="askQuestion('Как рассчитывается сумма ущерба?')">
                            Как рассчитывается сумма ущерба?
                        </button>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Задайте вопрос о деле..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="chat-send" onclick="sendMessage()" id="sendButton" aria-label="Отправить">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Saved Tab Content -->
        <div class="chat-tab-content" id="savedTabContent">
            <div class="saved-tab-view" id="savedTabView">
                <div class="saved-empty" id="savedEmpty">
                    <p>💾 Нет сохранённых ответов</p>
                    <p style="font-size: 0.8rem; margin-top: 0.5rem;">Нажмите кнопку "Сохранить" под ответом, чтобы добавить его сюда</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleCard(card) {
            card.classList.toggle('expanded');
        }

        // Expand first card by default
        document.addEventListener('DOMContentLoaded', function() {
            const firstCard = document.querySelector('.card');
            if (firstCard) {
                firstCard.classList.add('expanded');
            }
        });

        // ========== AI Chat Functionality ==========

        const API_URL = '/api/chat'; // Vercel API route
        let isLoading = false;
        let conversationHistory = [];

        function toggleChat() {
            const modal = document.getElementById('chatModal');
            modal.classList.toggle('open');
            if (modal.classList.contains('open')) {
                document.getElementById('chatInput').focus();
                updateSavedBadge();
            }
        }

        function switchTab(tab) {
            const chatTab = document.getElementById('tabChat');
            const savedTab = document.getElementById('tabSaved');
            const chatContent = document.getElementById('chatTabContent');
            const savedContent = document.getElementById('savedTabContent');

            if (tab === 'chat') {
                chatTab.classList.add('active');
                savedTab.classList.remove('active');
                chatContent.classList.add('active');
                savedContent.classList.remove('active');
                document.getElementById('chatInput').focus();
            } else {
                chatTab.classList.remove('active');
                savedTab.classList.add('active');
                chatContent.classList.remove('active');
                savedContent.classList.add('active');
                renderSavedResponses();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        // Saved responses storage
        let savedResponses = JSON.parse(localStorage.getItem('savedResponses') || '[]');

        function addMessage(content, role) {
            const messagesContainer = document.getElementById('chatMessages');

            // Remove welcome message on first message
            const welcome = messagesContainer.querySelector('.chat-welcome');
            if (welcome) {
                welcome.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = `chat-message-wrapper ${role}`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = formatMessage(content);
            wrapper.appendChild(messageDiv);

            // Add save button for assistant messages
            if (role === 'assistant') {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-btn';
                saveBtn.innerHTML = '💾 Сохранить';
                saveBtn.onclick = () => saveResponse(content, saveBtn);
                wrapper.appendChild(saveBtn);
            }

            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function saveResponse(content, btn) {
            const timestamp = new Date().toLocaleString('ru-RU');

            savedResponses.push({ content, timestamp, id: Date.now() });
            localStorage.setItem('savedResponses', JSON.stringify(savedResponses));

            btn.innerHTML = '✓ Сохранено';
            btn.classList.add('saved');
            btn.disabled = true;

            updateSavedBadge();
        }

        function updateSavedBadge() {
            const badge = document.getElementById('savedBadge');
            if (savedResponses.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = savedResponses.length;
            } else {
                badge.style.display = 'none';
            }
        }

        function renderSavedResponses() {
            const view = document.getElementById('savedTabView');
            const empty = document.getElementById('savedEmpty');

            if (savedResponses.length === 0) {
                empty.style.display = 'block';
                // Remove all cards
                view.querySelectorAll('.saved-card').forEach(c => c.remove());
                return;
            }

            empty.style.display = 'none';

            // Clear existing cards
            view.querySelectorAll('.saved-card').forEach(c => c.remove());

            // Render cards (newest first)
            [...savedResponses].reverse().forEach((item, idx) => {
                const realIndex = savedResponses.length - 1 - idx;
                const card = document.createElement('div');
                card.className = 'saved-card';
                card.innerHTML = `
                    <div class="saved-card-header">
                        <span class="saved-card-date">${item.timestamp}</span>
                        <div class="saved-card-actions">
                            <button class="saved-card-btn" onclick="copySaved(${realIndex})" title="Копировать">📋</button>
                            <button class="saved-card-btn delete" onclick="deleteSaved(${realIndex})" title="Удалить">🗑️</button>
                        </div>
                    </div>
                    <div class="saved-card-content" id="savedContent${realIndex}">${formatMessage(item.content)}</div>
                    <button class="saved-card-expand" onclick="toggleSavedExpand(${realIndex})">Показать полностью</button>
                `;
                view.appendChild(card);
            });
        }

        function toggleSavedExpand(index) {
            const content = document.getElementById('savedContent' + index);
            content.classList.toggle('expanded');
            const btn = content.nextElementSibling;
            btn.textContent = content.classList.contains('expanded') ? 'Свернуть' : 'Показать полностью';
        }

        function copySaved(index) {
            const item = savedResponses[index];
            if (item) {
                navigator.clipboard.writeText(item.content).then(() => {
                    alert('Скопировано в буфер обмена!');
                });
            }
        }

        function deleteSaved(index) {
            if (confirm('Удалить сохранённый ответ?')) {
                savedResponses.splice(index, 1);
                localStorage.setItem('savedResponses', JSON.stringify(savedResponses));
                updateSavedBadge();
                renderSavedResponses();
            }
        }

        function formatMessage(content) {
            // Enhanced markdown formatting
            let html = content;

            // Escape HTML first
            html = html.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // LaTeX block formulas $$...$$ -> styled formula block
            html = html.replace(/\$\$([^$]+)\$\$/g, '<div class="formula">$1</div>');

            // LaTeX inline formulas $...$ -> styled inline formula
            html = html.replace(/\$([^$\n]+)\$/g, '<code class="formula-inline">$1</code>');

            // Headers (### Header)
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');

            // Bold (**text**)
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Italic (*text*)
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');

            // Bullet lists (* item or - item)
            html = html.replace(/^[\*\-] (.+)$/gm, '<li>$1</li>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Numbered lists (1. item)
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // Paragraphs (double newline)
            html = html.replace(/\n\n/g, '</p><p>');

            // Single newlines (but not after block elements)
            html = html.replace(/(?<!<\/h3>|<\/ul>|<\/li>|<\/p>)\n(?!<)/g, '<br>');

            // Clean up extra <br> after block elements
            html = html.replace(/<\/h3><br>/g, '</h3>');
            html = html.replace(/<\/ul><br>/g, '</ul>');

            // Wrap in paragraph if not starting with block element
            if (!html.startsWith('<h3>') && !html.startsWith('<ul>') && !html.startsWith('<p>')) {
                html = '<p>' + html + '</p>';
            }

            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');

            return html;
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function showError(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chat-error';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();

            if (!message || isLoading) return;

            isLoading = true;
            sendButton.disabled = true;
            input.value = '';

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            showTyping();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10) // Last 10 messages for context
                    }),
                });

                hideTyping();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                let responseContent = data.response;

                // Add sources info
                if (data.sources && data.sources.length > 0) {
                    const sourcesList = data.sources.map(s => `<li>${s}</li>`).join('');
                    responseContent += `\n\n<div class="sources"><strong>📚 Использованы документы из базы знаний:</strong><ul>${sourcesList}</ul></div>`;
                } else {
                    responseContent += `\n\n<div class="sources no-sources"><strong>⚠️ Документы из базы знаний не найдены</strong><br>Ответ основан на общих знаниях модели</div>`;
                }

                addMessage(responseContent, 'assistant');
                conversationHistory.push({ role: 'assistant', content: data.response });

            } catch (error) {
                hideTyping();
                console.error('Chat error:', error);
                showError('Не удалось получить ответ. Проверьте подключение к серверу.');
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        // ========== Admin Panel Functionality ==========

        let adminPassword = null;

        function toggleAdmin() {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('open');
            if (modal.classList.contains('open')) {
                if (adminPassword) {
                    document.getElementById('docTitle').focus();
                } else {
                    document.getElementById('adminPassword').focus();
                }
            }
        }

        function closeAdminOnBackdrop(event) {
            if (event.target.id === 'adminModal') {
                toggleAdmin();
            }
        }

        function handleAdminKeyPress(event) {
            if (event.key === 'Enter') {
                adminLogin();
            }
        }

        function showAdminMessage(message, type) {
            const msgDiv = document.getElementById('adminMessage');
            msgDiv.innerHTML = `<div class="admin-message ${type}">${message}</div>`;
            setTimeout(() => {
                msgDiv.innerHTML = '';
            }, 5000);
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;

            if (!password) {
                showAdminMessage('Введите пароль', 'error');
                return;
            }

            // Store password for API calls
            adminPassword = password;

            // Switch to upload form
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminUploadForm').style.display = 'block';
            document.getElementById('adminTitle').textContent = 'Панель администратора';
            document.getElementById('adminPassword').value = '';

            // Load documents count
            loadDocuments();
        }

        function adminLogout() {
            adminPassword = null;
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminUploadForm').style.display = 'none';
            document.getElementById('adminTitle').textContent = 'Вход администратора';
            clearUploadForm();
        }

        function clearUploadForm() {
            document.getElementById('docTitle').value = '';
            document.getElementById('docContent').value = '';
            document.getElementById('docSource').value = '';
            document.getElementById('docCategory').value = 'документ';
            clearFile();
        }

        async function uploadDocument() {
            const title = document.getElementById('docTitle').value.trim();
            const content = document.getElementById('docContent').value.trim();
            const source = document.getElementById('docSource').value.trim();
            const category = document.getElementById('docCategory').value;
            const uploadBtn = document.getElementById('uploadBtn');

            if (!title || !content) {
                showAdminMessage('Заполните название и содержимое документа', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Загрузка...';

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: adminPassword,
                        title,
                        content,
                        source,
                        category
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showAdminMessage('Неверный пароль', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error(data.error || 'Ошибка загрузки');
                }

                showAdminMessage(data.message, 'success');
                clearUploadForm();
                // Refresh document list
                loadDocuments();

            } catch (error) {
                console.error('Upload error:', error);
                showAdminMessage(error.message || 'Ошибка загрузки документа', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Загрузить документ в базу знаний';
            }
        }

        // ========== Document Management ==========

        let currentPage = 1;
        const docsPerPage = 20;

        function switchAdminTab(tab) {
            const uploadTab = document.getElementById('adminTabUpload');
            const docsTab = document.getElementById('adminTabDocuments');
            const uploadContent = document.getElementById('adminUploadTabContent');
            const docsContent = document.getElementById('adminDocsTabContent');

            if (tab === 'upload') {
                uploadTab.classList.add('active');
                docsTab.classList.remove('active');
                uploadContent.classList.add('active');
                docsContent.classList.remove('active');
            } else {
                uploadTab.classList.remove('active');
                docsTab.classList.add('active');
                uploadContent.classList.remove('active');
                docsContent.classList.add('active');
                loadDocuments();
            }
        }

        async function loadDocuments() {
            const docList = document.getElementById('docList');
            const category = document.getElementById('docFilterCategory').value;

            docList.innerHTML = '<div class="doc-loading">Загрузка документов...</div>';

            try {
                const params = new URLSearchParams({
                    password: adminPassword,
                    page: currentPage,
                    limit: docsPerPage,
                    category: category
                });

                const response = await fetch(`/api/documents?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showAdminMessage('Сессия истекла', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error(data.error);
                }

                // Update counts
                document.getElementById('totalDocsCount').textContent = data.total;
                document.getElementById('docCountBadge').textContent = data.total;

                // Render documents
                if (data.documents.length === 0) {
                    docList.innerHTML = '<div class="doc-empty">Документы не найдены</div>';
                } else {
                    docList.innerHTML = data.documents.map(doc => renderDocItem(doc)).join('');
                }

                // Update pagination
                const totalPages = Math.ceil(data.total / docsPerPage);
                const pagination = document.getElementById('docPagination');
                if (totalPages > 1) {
                    pagination.style.display = 'flex';
                    document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
                    document.getElementById('prevPageBtn').disabled = currentPage === 1;
                    document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
                } else {
                    pagination.style.display = 'none';
                }

            } catch (error) {
                console.error('Load documents error:', error);
                docList.innerHTML = '<div class="doc-empty">Ошибка загрузки документов</div>';
            }
        }

        function renderDocItem(doc) {
            const date = doc.created_at ? new Date(doc.created_at).toLocaleDateString('ru-RU') : '';
            const categoryLabels = {
                'документ': 'Документ',
                'договор': 'Договор',
                'акт': 'Акт',
                'переписка': 'Переписка',
                'заключение': 'Заключение',
                'судебный_акт': 'Судебный акт',
                'процессуальный_документ': 'Процессуальный док.',
                'нормативный_акт': 'Норм. акт',
                'отчет': 'Отчёт',
                'справка_ии': 'Справка ИИ'
            };

            return `
                <div class="doc-item">
                    <div class="doc-item-info">
                        <div class="doc-item-title" title="${escapeHtml(doc.title)}">${escapeHtml(doc.title)}</div>
                        <div class="doc-item-meta">
                            <span class="doc-item-category">${categoryLabels[doc.category] || doc.category}</span>
                            ${date ? `<span>${date}</span>` : ''}
                        </div>
                    </div>
                    <div class="doc-item-actions">
                        <button class="doc-item-btn" onclick="editDocument('${doc.id}')" title="Редактировать">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="doc-item-btn delete" onclick="deleteDocument('${doc.id}', '${escapeHtml(doc.title)}')" title="Удалить">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function changePage(delta) {
            currentPage += delta;
            loadDocuments();
        }

        // Documents cache for editing
        let documentsCache = {};

        async function editDocument(id) {
            try {
                // Fetch document data
                const params = new URLSearchParams({
                    password: adminPassword,
                    page: 1,
                    limit: 1000
                });
                const response = await fetch(`/api/documents?${params}`);
                const data = await response.json();

                const doc = data.documents.find(d => d.id === id);
                if (!doc) {
                    showAdminMessage('Документ не найден', 'error');
                    return;
                }

                // Fill edit form
                document.getElementById('editDocId').value = doc.id;
                document.getElementById('editDocTitle').value = doc.title || '';
                document.getElementById('editDocContent').value = doc.content || '';
                document.getElementById('editDocSource').value = doc.source || '';
                document.getElementById('editDocCategory').value = doc.category || 'документ';

                // Show modal
                document.getElementById('editModal').classList.add('open');

            } catch (error) {
                console.error('Edit document error:', error);
                showAdminMessage('Ошибка загрузки документа', 'error');
            }
        }

        function closeEditModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('editModal').classList.remove('open');
            }
        }

        async function saveDocument() {
            const id = document.getElementById('editDocId').value;
            const title = document.getElementById('editDocTitle').value.trim();
            const content = document.getElementById('editDocContent').value.trim();
            const source = document.getElementById('editDocSource').value.trim();
            const category = document.getElementById('editDocCategory').value;

            if (!title || !content) {
                showAdminMessage('Заполните название и содержимое', 'error');
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        id: id,
                        title,
                        content,
                        source,
                        category
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage('Документ обновлён', 'success');
                closeEditModal();
                loadDocuments();

            } catch (error) {
                console.error('Save document error:', error);
                showAdminMessage(error.message || 'Ошибка сохранения', 'error');
            }
        }

        async function deleteDocument(id, title) {
            if (!confirm(`Удалить документ "${title}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        id: id
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage('Документ удалён', 'success');
                loadDocuments();

            } catch (error) {
                console.error('Delete document error:', error);
                showAdminMessage(error.message || 'Ошибка удаления', 'error');
            }
        }

        async function deleteAllDocuments() {
            const total = document.getElementById('totalDocsCount').textContent;
            if (!confirm(`Вы уверены, что хотите удалить ВСЕ ${total} документов из базы знаний? Это действие нельзя отменить!`)) {
                return;
            }

            if (!confirm('Подтвердите удаление ещё раз. Все данные будут потеряны!')) {
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        deleteAll: true
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage(`Удалено ${data.deletedCount || 'все'} документов`, 'success');
                loadDocuments();

            } catch (error) {
                console.error('Delete all documents error:', error);
                showAdminMessage(error.message || 'Ошибка удаления', 'error');
            }
        }

        // ========== File Upload & OCR Functionality ==========

        let currentFile = null;

        // Initialize drag & drop when admin form is shown
        function initDropZone() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        async function processFile(file) {
            // Определяем тип файла
            const isImage = file.type.startsWith('image/');
            const isPDF = file.type === 'application/pdf';
            const isText = file.name.endsWith('.md') || file.name.endsWith('.txt') || file.type === 'text/plain' || file.type === 'text/markdown';
            const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

            // Validate file type
            if (!isImage && !isPDF && !isText && !isDOCX) {
                showAdminMessage('Поддерживаются: изображения, PDF, DOCX, Markdown (.md), TXT', 'error');
                return;
            }

            // Validate file size (max 20MB for PDF/DOCX, 10MB for others)
            const maxSize = (isPDF || isDOCX) ? 20 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showAdminMessage(`Файл слишком большой. Максимум ${(isPDF || isDOCX) ? '20' : '10'} МБ`, 'error');
                return;
            }

            currentFile = file;
            showFilePreview(file);
            await recognizeDocument(file);
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const previewName = document.getElementById('previewName');
            const previewSize = document.getElementById('previewSize');

            previewName.textContent = file.name;
            previewSize.textContent = formatFileSize(file.size);

            const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // PDF icon
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="7" y="16" font-size="6" fill="#e53e3e" stroke="none">PDF</text></svg>');
            } else if (isDOCX) {
                // DOCX icon (blue)
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2b579a" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="5" y="16" font-size="5" fill="#2b579a" stroke="none">DOCX</text></svg>');
            } else {
                // Text/Markdown icon
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#718096" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>');
            }

            preview.style.display = 'flex';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' Б';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' КБ';
            return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        function updateProcessingText(text) {
            document.getElementById('processingText').textContent = text;
        }

        async function recognizeDocument(file) {
            const dropZone = document.getElementById('dropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');
            const processingIndicator = document.getElementById('processingIndicator');

            // Show processing state
            dropZone.classList.add('processing');
            dropZoneContent.style.display = 'none';
            processingIndicator.style.display = 'flex';
            updateProcessingText('Подготовка файла...');

            try {
                let requestBody;
                const isText = file.name.endsWith('.md') || file.name.endsWith('.txt') || file.type === 'text/plain' || file.type === 'text/markdown';
                const isPDF = file.type === 'application/pdf';
                const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

                if (isText) {
                    // Текстовые файлы - читаем как текст
                    updateProcessingText('Анализ текстового документа...');
                    const textContent = await readFileAsText(file);
                    requestBody = {
                        password: adminPassword,
                        textContent: textContent,
                        fileType: 'text',
                        fileName: file.name
                    };
                } else if (isDOCX) {
                    // DOCX - извлекаем текст через mammoth.js
                    updateProcessingText('Извлечение текста из DOCX...');
                    const textContent = await extractDocxText(file);
                    requestBody = {
                        password: adminPassword,
                        textContent: textContent,
                        fileType: 'text',
                        fileName: file.name
                    };
                } else if (isPDF) {
                    // PDF - конвертируем все страницы в изображения
                    updateProcessingText('Загрузка PDF...');
                    const images = await convertPdfToImages(file);
                    updateProcessingText(`Распознавание ${images.length} стр...`);
                    requestBody = {
                        password: adminPassword,
                        images: images,
                        fileName: file.name
                    };
                } else {
                    // Изображение
                    updateProcessingText('ИИ распознаёт документ...');
                    const base64 = await fileToBase64(file);
                    requestBody = {
                        password: adminPassword,
                        image: base64,
                        mediaType: file.type,
                        fileName: file.name
                    };
                }

                // Call recognition API
                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showAdminMessage('Неверный пароль', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error(data.error || 'Ошибка распознавания');
                }

                // Fill the form with recognized data
                if (data.title) {
                    document.getElementById('docTitle').value = data.title;
                }
                if (data.content) {
                    document.getElementById('docContent').value = data.content;
                }
                if (data.source) {
                    document.getElementById('docSource').value = data.source;
                }
                if (data.category) {
                    const categorySelect = document.getElementById('docCategory');
                    const option = Array.from(categorySelect.options).find(opt => opt.value === data.category);
                    if (option) {
                        categorySelect.value = data.category;
                    }
                }

                showAdminMessage('Документ распознан! Проверьте и отредактируйте данные', 'success');

            } catch (error) {
                console.error('Recognition error:', error);
                showAdminMessage(error.message || 'Ошибка распознавания документа', 'error');
            } finally {
                // Reset drop zone state
                dropZone.classList.remove('processing');
                dropZoneContent.style.display = 'block';
                processingIndicator.style.display = 'none';
                updateProcessingText('ИИ распознаёт документ...');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data URL prefix to get pure base64
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Извлечение текста из DOCX через mammoth.js
        async function extractDocxText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const arrayBuffer = reader.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function convertPdfToImages(file) {
            // Инициализируем PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const numPages = pdf.numPages;
            const images = [];

            // Рендерим каждую страницу
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                updateProcessingText(`Обработка страницы ${pageNum}/${numPages}...`);

                const page = await pdf.getPage(pageNum);
                // Масштаб 1.5 - баланс качества и размера
                const scale = 1.5;
                const viewport = page.getViewport({ scale });

                // Ограничиваем максимальный размер (макс 1500px по большей стороне)
                const maxDimension = 1500;
                let finalScale = scale;
                if (viewport.width > maxDimension || viewport.height > maxDimension) {
                    const ratio = maxDimension / Math.max(viewport.width, viewport.height);
                    finalScale = scale * ratio;
                }
                const finalViewport = page.getViewport({ scale: finalScale });

                // Создаём canvas для рендеринга
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = finalViewport.width;
                canvas.height = finalViewport.height;

                // Рендерим страницу
                await page.render({
                    canvasContext: context,
                    viewport: finalViewport
                }).promise;

                // Конвертируем в JPEG с качеством 0.8 для меньшего размера
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const base64 = dataUrl.split(',')[1];

                images.push({
                    data: base64,
                    mediaType: 'image/jpeg',
                    pageNumber: pageNum
                });
            }

            return images;
        }

        // Initialize drop zone when DOM is ready
        document.addEventListener('DOMContentLoaded', initDropZone);
    </script>

    <!-- Регистрация Service Worker для PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker зарегистрирован:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Ошибка регистрации Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
