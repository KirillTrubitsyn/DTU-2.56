<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>АО «Дальтрансуголь» — Анализ линий защиты</title>

    <!-- Favicon и иконки -->
    <link rel="icon" type="image/x-icon" href="favicon-32.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- PWA манифест -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA мета-теги -->
    <meta name="theme-color" content="#1a365d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Дальтрансуголь">
    <meta name="application-name" content="Дальтрансуголь">
    <meta name="msapplication-TileColor" content="#1a365d">
    <meta name="msapplication-TileImage" content="icon-192.png">

    <!-- PDF.js для рендеринга PDF страниц -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mammoth.js для чтения DOCX файлов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- docx.js для создания DOCX файлов -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <!-- FileSaver.js для скачивания файлов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent-gold: #d69e2e;
            --strong: #38a169;
            --strong-light: #c6f6d5;
            --medium: #3182ce;
            --medium-light: #bee3f8;
            --weak: #e53e3e;
            --weak-light: #fed7d7;
            --neutral: #3182ce;
            --neutral-light: #bee3f8;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-muted: #718096;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: pulse 15s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .header .case-number {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .header .claim-amount {
            display: inline-block;
            background: var(--accent-gold);
            color: var(--primary);
            padding: 0.5rem 1.5rem;
            border-radius: 2rem;
            font-weight: 700;
            margin-top: 1rem;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: transform 0.2s;
        }

        .legend-item:hover {
            transform: scale(1.05);
        }

        .legend-item.strong {
            background: var(--strong-light);
            color: var(--strong);
            border: 2px solid var(--strong);
        }

        .legend-item.medium {
            background: var(--medium-light);
            color: #744210;
            border: 2px solid var(--medium);
        }

        .legend-item.weak {
            background: var(--weak-light);
            color: var(--weak);
            border: 2px solid var(--weak);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-item.strong .legend-dot { background: var(--strong); }
        .legend-item.medium .legend-dot { background: var(--medium); }
        .legend-item.weak .legend-dot { background: var(--weak); }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }

        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .card.strong { border-left-color: var(--strong); }
        .card.medium { border-left-color: var(--medium); }
        .card.weak { border-left-color: var(--weak); }

        .card-header {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            user-select: none;
        }

        .card.strong .card-header { background: linear-gradient(90deg, var(--strong-light) 0%, transparent 100%); }
        .card.medium .card-header { background: linear-gradient(90deg, var(--medium-light) 0%, transparent 100%); }
        .card.weak .card-header { background: linear-gradient(90deg, var(--weak-light) 0%, transparent 100%); }

        .card-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            flex-shrink: 0;
        }

        .card.strong .card-number { background: var(--strong); }
        .card.medium .card-number { background: var(--medium); }
        .card.weak .card-number { background: var(--weak); }

        .card-title-area {
            flex: 1;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .card-badges {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-strength {
            background: var(--primary);
            color: white;
        }

        .badge-court {
            background: var(--border);
            color: var(--text-muted);
        }

        .badge-court.yes { background: #bee3f8; color: #2b6cb0; }
        .badge-court.no { background: #e2e8f0; color: #718096; }
        .badge-court.partial { background: #fefcbf; color: #744210; }

        .expand-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.3s;
            color: var(--text-muted);
        }

        .card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .card.expanded .card-content {
            max-height: 2000px;
        }

        .card-body {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .info-section {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }

        .info-section h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-section h4::before {
            content: '';
            width: 4px;
            height: 16px;
            border-radius: 2px;
        }

        .info-section.rpn h4::before { background: #e53e3e; }
        .info-section.court h4::before { background: #3182ce; }
        .info-section.rec h4::before { background: #38a169; }
        .info-section.arg h4::before { background: #805ad5; }

        .info-section ul {
            list-style: none;
            padding: 0;
        }

        .info-section li {
            padding: 0.5rem 0;
            padding-left: 1.25rem;
            position: relative;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
        }

        .info-section li:last-child {
            border-bottom: none;
        }

        .info-section li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--text-muted);
        }

        .info-section p {
            font-size: 0.9rem;
            color: var(--text);
        }

        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fef3c7 100%);
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }

        .court-decision {
            background: #ebf8ff;
            border-left: 3px solid #3182ce;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.85rem;
        }

        .court-decision .date {
            font-weight: 600;
            color: #2b6cb0;
        }

        .abandon-banner {
            background: linear-gradient(90deg, var(--weak-light) 0%, #fff 100%);
            border: 2px dashed var(--weak);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .abandon-banner strong {
            color: var(--weak);
        }

        .strategy-section {
            margin-top: 3rem;
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .strategy-section h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .strategy-card {
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            transition: transform 0.3s;
        }

        .strategy-card:hover {
            transform: scale(1.02);
        }

        .strategy-card.priority {
            background: linear-gradient(135deg, var(--strong-light) 0%, #9ae6b4 100%);
            border: 2px solid var(--strong);
        }

        .strategy-card.support {
            background: linear-gradient(135deg, var(--medium-light) 0%, #fbd38d 100%);
            border: 2px solid var(--medium);
        }

        .strategy-card.abandon {
            background: linear-gradient(135deg, var(--weak-light) 0%, #fc8181 100%);
            border: 2px solid var(--weak);
        }

        .strategy-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        .strategy-card.priority h3 { color: #276749; }
        .strategy-card.support h3 { color: #744210; }
        .strategy-card.abandon h3 { color: #c53030; }

        .strategy-card p {
            font-size: 0.9rem;
            color: var(--text);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .card.strong .progress-bar .fill { background: var(--strong); }
        .card.medium .progress-bar .fill { background: var(--medium); }
        .card.weak .progress-bar .fill { background: var(--weak); }

        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-muted);
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.3rem; }
            .card-header { flex-wrap: wrap; }
            .card-badges { width: 100%; margin-top: 0.5rem; }
            .info-grid { grid-template-columns: 1fr; }
            .strategy-grid { grid-template-columns: 1fr; }
        }

        /* AI Chat Styles */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(26, 54, 93, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(26, 54, 93, 0.5);
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .chat-fab .badge-notify {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-gold);
            color: var(--primary);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .chat-modal {
            display: none;
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 600px;
            max-width: calc(100vw - 2rem);
            height: 700px;
            max-height: calc(100vh - 8rem);
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
            animation: slideUp 0.3s ease;
        }

        .chat-modal.open {
            display: flex;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-icon svg {
            width: 22px;
            height: 22px;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .chat-header-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Chat tabs */
        .chat-tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .chat-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .chat-tab:hover {
            color: var(--text);
            background: var(--bg);
        }
        .chat-tab.active {
            color: var(--primary);
        }
        .chat-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        .chat-tab-badge {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* Tab content */
        .chat-tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .chat-tab-content.active {
            display: flex;
        }

        /* Saved tab view */
        .saved-tab-view {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg);
        }
        .saved-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }
        .saved-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        .saved-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .saved-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .saved-card-actions {
            display: flex;
            gap: 0.5rem;
        }
        .saved-card-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .saved-card-btn:hover {
            color: var(--primary);
        }
        .saved-card-btn.delete:hover {
            color: var(--danger);
        }
        .saved-card-content {
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 150px;
            overflow: hidden;
            position: relative;
        }
        .saved-card-content.expanded {
            max-height: none;
        }
        .saved-card-expand {
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem 0 0 0;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg);
        }

        .chat-message {
            max-width: 85%;
            padding: 0.875rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            align-self: flex-start;
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant .sources {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chat-message.assistant .sources-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.8rem;
        }
        .chat-message.assistant .sources-toggle:hover {
            text-decoration: underline;
        }
        .chat-message.assistant .sources-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }
        .chat-message.assistant .sources-toggle.open svg {
            transform: rotate(90deg);
        }
        .chat-message.assistant .sources-list {
            display: none;
            margin-top: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid var(--border);
        }
        .chat-message.assistant .sources-list.open {
            display: block;
        }
        .chat-message.assistant .sources-list li {
            margin: 0.25rem 0;
            list-style: none;
        }

        .chat-message.typing {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
        }

        .chat-message.typing span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .chat-message.typing span:nth-child(1) { animation-delay: -0.32s; }
        .chat-message.typing span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Web search toggle */
        .chat-options {
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Web sources styling */
        .web-sources {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border);
        }
        .web-sources-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #0066cc;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.8rem;
        }
        .web-sources-toggle:hover {
            text-decoration: underline;
        }
        .web-sources-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }
        .web-sources-toggle.open svg {
            transform: rotate(90deg);
        }
        .web-sources-list {
            display: none;
            margin-top: 0.5rem;
            padding-left: 0.5rem;
        }
        .web-sources-list.open {
            display: block;
        }
        .web-sources-list a {
            display: block;
            color: #0066cc;
            text-decoration: none;
            font-size: 0.8rem;
            margin: 0.25rem 0;
        }
        .web-sources-list a:hover {
            text-decoration: underline;
        }

        .chat-input-area {
            padding: 1rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 1.5rem;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .chat-send:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .chat-send svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .chat-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-options {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 0.25rem;
        }

        .think-longer-toggle {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            user-select: none;
            transition: color 0.2s;
        }

        .think-longer-toggle:hover {
            color: var(--text);
        }

        .think-longer-toggle input {
            display: none;
        }

        .think-longer-toggle .toggle-switch {
            width: 32px;
            height: 18px;
            background: var(--border);
            border-radius: 9px;
            position: relative;
            transition: background 0.2s;
        }

        .think-longer-toggle .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .think-longer-toggle input:checked + .toggle-switch {
            background: var(--primary);
        }

        .think-longer-toggle input:checked + .toggle-switch::after {
            transform: translateX(14px);
        }

        .think-longer-toggle .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .think-longer-toggle .toggle-label svg {
            width: 14px;
            height: 14px;
        }

        .chat-welcome {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
        }

        .chat-welcome h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .chat-welcome p {
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .chat-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-suggestion {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chat-suggestion:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .chat-error {
            background: var(--weak-light);
            color: var(--weak);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            margin: 0.5rem 1rem;
        }

        /* Tablet styles */
        @media (max-width: 1024px) {
            .chat-modal {
                width: 500px;
                height: 650px;
            }
        }

        /* Mobile styles - fullscreen chat */
        @media (max-width: 768px) {
            .chat-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
                z-index: 9999;
            }
            .chat-fab {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 56px;
                height: 56px;
            }
            .chat-header {
                padding: 1rem;
            }
            .chat-tabs {
                padding: 0;
            }
            .chat-tab {
                padding: 1rem;
                font-size: 0.9rem;
            }
            .chat-messages {
                padding: 0.75rem;
            }
            .chat-input-area {
                padding: 0.75rem;
                padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            }
            .chat-input {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            .saved-tab-view {
                padding: 0.75rem;
            }
            .saved-card {
                padding: 0.75rem;
            }
            .admin-fab {
                bottom: 1rem;
                right: 5rem;
            }
        }

        /* Admin Panel Styles */
        .admin-fab {
            position: fixed;
            bottom: 2rem;
            right: 7rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(113, 128, 150, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .admin-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(113, 128, 150, 0.5);
        }

        .admin-fab svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .admin-modal.open {
            display: flex;
        }

        .admin-panel {
            background: var(--card-bg);
            border-radius: 1rem;
            width: 500px;
            max-width: calc(100vw - 2rem);
            max-height: calc(100vh - 4rem);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        .admin-header {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .admin-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .admin-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .admin-close:hover {
            opacity: 1;
        }

        .admin-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 12rem);
        }

        .admin-form-group {
            margin-bottom: 1.25rem;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }

        .admin-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .admin-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .admin-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .admin-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        .admin-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        .admin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .admin-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .admin-message.success {
            background: var(--strong-light);
            color: var(--strong);
        }

        .admin-message.error {
            background: var(--weak-light);
            color: var(--weak);
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .admin-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-tab:hover {
            color: var(--primary);
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Document Stats */
        .doc-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .doc-stats-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .doc-stats-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Category Filter */
        .doc-filter {
            margin-bottom: 1rem;
        }

        .doc-filter select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            background: white;
        }

        /* Document List */
        .doc-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .doc-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            transition: all 0.2s;
        }

        .doc-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .doc-item-info {
            flex: 1;
            min-width: 0;
        }

        .doc-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doc-item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .doc-item-category {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: var(--bg);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .doc-item-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .doc-item-btn {
            padding: 0.375rem;
            background: none;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .doc-item-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .doc-item-btn.delete:hover {
            border-color: var(--weak);
            color: var(--weak);
        }

        .doc-item-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Loading state */
        .doc-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .doc-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Pagination */
        .doc-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .doc-pagination button {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .doc-pagination button:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .doc-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .doc-pagination span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Edit Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .edit-modal.open {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .edit-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .admin-login-form {
            text-align: center;
        }

        .admin-login-form svg {
            width: 48px;
            height: 48px;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .admin-login-form p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* File Upload / Drop Zone Styles */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg);
            margin-bottom: 1.25rem;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.05);
        }

        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.1);
            transform: scale(1.02);
        }

        .drop-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .drop-zone-text {
            color: var(--text);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .drop-zone-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .camera-btn {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .camera-btn:hover {
            background: var(--primary-light);
        }

        @media (max-width: 768px) {
            .camera-btn {
                display: inline-flex;
            }
        }

        .drop-zone input[type="file"] {
            display: none;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
        }

        .processing-indicator .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .file-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .file-preview-info {
            flex: 1;
            min-width: 0;
        }

        .file-preview-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-preview-size {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .file-preview-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .file-preview-remove:hover {
            color: var(--weak);
        }

        .admin-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.25rem 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .admin-divider::before,
        .admin-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Markdown styling in chat */
        .chat-message h3 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0.75rem 0 0.5rem 0;
            color: var(--primary);
        }
        .chat-message h3:first-child {
            margin-top: 0;
        }
        .chat-message ul, .chat-message ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        .chat-message li {
            margin: 0.25rem 0;
        }
        .chat-message p {
            margin: 0.5rem 0;
        }
        .chat-message p:first-child {
            margin-top: 0;
        }

        /* Formula styling */
        .chat-message .formula {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin: 0.75rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .chat-message .formula-inline {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            padding: 0.15rem 0.4rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* Save button */
        .chat-message-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        .chat-message-wrapper.user {
            align-items: flex-end;
        }
        .save-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }
        .chat-message-wrapper:hover .save-btn {
            opacity: 1;
        }
        .save-btn:hover {
            background: var(--bg);
            color: var(--primary);
        }
        .save-btn.saved {
            opacity: 1;
            color: var(--success);
        }

        /* Main Page Tabs */
        .main-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .main-tab {
            padding: 0.75rem 2rem;
            border: none;
            background: var(--card-bg);
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .main-tab:hover {
            background: var(--primary-light);
            color: white;
        }

        .main-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Timeline Styles */
        .timeline-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .timeline-section {
            margin-bottom: 3rem;
        }

        .timeline-section-title {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.2);
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary), var(--primary-light));
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 0.5rem;
            width: 14px;
            height: 14px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.3);
        }

        .timeline-item.positive::before {
            background: var(--strong);
        }

        .timeline-item.negative::before {
            background: var(--weak);
        }

        .timeline-item.neutral::before {
            background: var(--medium);
        }

        .timeline-item.key::before {
            width: 18px;
            height: 18px;
            left: -1.85rem;
            background: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(214, 158, 46, 0.3);
        }

        .timeline-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .timeline-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .timeline-item.positive .timeline-card {
            border-left-color: var(--strong);
        }

        .timeline-item.negative .timeline-card {
            border-left-color: var(--weak);
        }

        .timeline-item.neutral .timeline-card {
            border-left-color: var(--medium);
        }

        .timeline-item.key .timeline-card {
            border-left-color: var(--accent-gold);
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .timeline-date {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .timeline-item.positive .timeline-date {
            background: var(--strong);
        }

        .timeline-item.negative .timeline-date {
            background: var(--weak);
        }

        .timeline-item.neutral .timeline-date {
            background: var(--medium);
        }

        .timeline-item.key .timeline-date {
            background: var(--accent-gold);
            color: var(--primary);
        }

        /* Стили для событий ВаниноТрансУголь */
        .timeline-item.vtu::before {
            background: #8B5CF6;
        }

        .timeline-item.vtu .timeline-card {
            border-left-color: #8B5CF6;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        }

        .timeline-item.vtu .timeline-date {
            background: #8B5CF6;
        }

        /* Стили для критически негативных событий */
        .timeline-item.critical::before {
            background: #DC2626;
            width: 18px;
            height: 18px;
            left: -1.85rem;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.6);
        }

        .timeline-item.critical .timeline-card {
            border-left-color: #DC2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .timeline-item.critical .timeline-date {
            background: #DC2626;
        }

        .timeline-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .timeline-description {
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .timeline-significance {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border-left: 3px solid var(--accent-gold);
        }

        .timeline-significance-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .timeline-significance-text {
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.5;
        }

        .timeline-docs {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }

        .timeline-docs-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .timeline-docs-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .timeline-docs-list li {
            font-size: 0.85rem;
            color: var(--primary);
            padding: 0.25rem 0;
            padding-left: 1.25rem;
            position: relative;
        }

        .timeline-docs-list li::before {
            content: '📄';
            position: absolute;
            left: 0;
            font-size: 0.75rem;
        }

        /* Timeline Section Accordion */
        .timeline-section-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0;
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .timeline-section-header:hover {
            box-shadow: 0 6px 16px rgba(26, 54, 93, 0.3);
            transform: translateY(-1px);
        }

        .timeline-section-header .section-toggle {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .timeline-section.collapsed .timeline-section-header .section-toggle {
            transform: rotate(-90deg);
        }

        .timeline-section-header .event-count {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            margin-left: auto;
            margin-right: 1rem;
        }

        .timeline-section-body {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 1;
            margin-top: 1.5rem;
        }

        .timeline-section.collapsed .timeline-section-body {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* Timeline Item Accordion */
        .timeline-card-header {
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .timeline-card-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border);
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .timeline-card-toggle:hover {
            color: var(--primary);
        }

        .timeline-card-toggle svg {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .timeline-item.collapsed .timeline-card-toggle svg {
            transform: rotate(-90deg);
        }

        .timeline-card-body {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease, margin 0.2s ease;
            opacity: 1;
            margin-top: 0.75rem;
        }

        .timeline-item.collapsed .timeline-card-body {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* Upcoming event style */
        .timeline-item.upcoming::before {
            background: #6366f1;
            animation: pulse-upcoming 2s infinite;
        }

        .timeline-item.upcoming .timeline-card {
            border-left-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        .timeline-item.upcoming .timeline-date {
            background: #6366f1;
        }

        @keyframes pulse-upcoming {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0); }
        }

        .upcoming-badge {
            display: inline-block;
            background: #6366f1;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Timeline Layout with Sidebar */
        .timeline-layout {
            display: flex;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .timeline-sidebar {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 80px;
            height: fit-content;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .timeline-main {
            flex: 1;
            min-width: 0;
        }

        .timeline-footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-light);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Calendar Navigation */
        .calendar-nav {
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .calendar-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .calendar-legend {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .calendar-legend-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            font-size: 0.8rem;
            color: var(--text);
        }

        .calendar-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-legend-dot.positive { background: var(--strong); }
        .calendar-legend-dot.negative { background: var(--weak); }
        .calendar-legend-dot.neutral { background: var(--medium); }
        .calendar-legend-dot.key { background: var(--accent-gold); }
        .calendar-legend-dot.upcoming { background: #6366f1; }

        /* Timeline Filters */
        .timeline-filters {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .timeline-filters-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .timeline-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .timeline-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid var(--border);
            border-radius: 1rem;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeline-filter-btn:hover {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.05);
        }

        .timeline-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .filter-dot.key { background: var(--accent-gold); }
        .filter-dot.positive { background: var(--strong); }
        .filter-dot.negative { background: var(--weak); }

        .timeline-filter-btn.active .filter-dot {
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }

        /* Hidden state for filtered items */
        .timeline-item.filtered-out {
            display: none !important;
        }

        .calendar-years {
            padding: 0.5rem;
        }

        .calendar-year {
            margin-bottom: 0.25rem;
        }

        .calendar-year-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text);
            transition: all 0.2s;
        }

        .calendar-year-header:hover {
            background: var(--primary-light);
            color: white;
        }

        .calendar-year-header .year-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calendar-year-header .event-dots {
            display: flex;
            gap: 2px;
        }

        .calendar-year-header .event-dots .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .calendar-year-header svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }

        .calendar-year.collapsed .calendar-year-header svg {
            transform: rotate(-90deg);
        }

        .calendar-year-events {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            opacity: 1;
        }

        .calendar-year.collapsed .calendar-year-events {
            max-height: 0;
            opacity: 0;
        }

        .calendar-event {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem 0.5rem 1.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: all 0.2s;
            border-left: 2px solid transparent;
        }

        .calendar-event:hover {
            background: var(--bg);
            color: var(--text);
            border-left-color: var(--primary);
        }

        .calendar-event .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-event .event-dot.positive { background: var(--strong); }
        .calendar-event .event-dot.negative { background: var(--weak); }
        .calendar-event .event-dot.neutral { background: var(--medium); }
        .calendar-event .event-dot.key { background: var(--accent-gold); }
        .calendar-event .event-dot.upcoming { background: #6366f1; }

        .calendar-event .event-date {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        .calendar-event .event-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Event highlight animation */
        .timeline-item.highlighted .timeline-card {
            animation: highlight-pulse 0.5s ease-out 3;
            box-shadow: 0 0 0 3px var(--accent-gold), 0 8px 24px rgba(0,0,0,0.15);
        }

        @keyframes highlight-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Mobile: hide sidebar */
        @media (max-width: 1024px) {
            .timeline-layout {
                flex-direction: column;
            }

            .timeline-sidebar {
                width: 100%;
                position: static;
                max-height: none;
            }

            .calendar-nav {
                margin-bottom: 1rem;
            }

            .calendar-years {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .calendar-year {
                flex: 1;
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .main-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .main-tab {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .timeline-container {
                padding: 1rem 0.5rem;
            }

            .timeline {
                padding-left: 1.5rem;
            }

            .timeline-item {
                padding-left: 1rem;
            }
        }

    </style>
</head>
<body>
    <header class="header">
        <h1>АО «ДАЛЬТРАНСУГОЛЬ»</h1>
        <p class="case-number">Дело № А73-19604/2025</p>
        <div class="claim-amount">Цена иска: 2 562 113 054,91 ₽</div>
    </header>

    <!-- Main Page Navigation Tabs -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('timeline')" id="mainTabTimeline">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            Хронология дела
        </button>
        <button class="main-tab" onclick="switchMainTab('analysis')" id="mainTabAnalysis">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Стратегия защиты
        </button>
    </div>

    <!-- Analysis Tab Content -->
    <div class="main-tab-content" id="analysisContent">
        <div class="container">
            <div class="legend">
            <div class="legend-item strong">
                <span class="legend-dot"></span>
                Сильный (8-10)
            </div>
            <div class="legend-item medium">
                <span class="legend-dot"></span>
                Средний (4-7)
            </div>
            <div class="legend-item weak">
                <span class="legend-dot"></span>
                Отказаться (1-3)
            </div>
        </div>

        <!-- Card 1: Constitutional Court -->
        <div class="card strong" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">1</div>
                <div class="card-title-area">
                    <div class="card-title">Позиция Конституционного Суда РФ</div>
                    <div class="card-subtitle">Постановление № 56-П от 06.12.2024</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">9/10</span>
                    <span class="badge badge-court no">Не заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 90%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Суд <strong>не вправе</strong> ограничиваться установлением элементов состава правонарушения. <span class="highlight">Обязан учитывать обстоятельства, исключающие или уменьшающие вред.</span> Формальное применение методик расчёта <strong>недопустимо</strong>. Требуется оценка фактических неблагоприятных экологических последствий.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Вероятная позиция Росприроднадзора</h4>
                            <ul>
                                <li>КС рассматривал конкретное дело, не аналогичное настоящему</li>
                                <li>Методика 87 утверждена Минприроды и подлежит обязательному применению</li>
                                <li>Суды правильно применили методику в соответствии с законом</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов</h4>
                            <p><strong>Не рассматривалось.</strong> Постановление КС вынесено 06.12.2024 — после завершения всех административных дел и решений арбитражных судов по делу А73-8310/2024 (АС ДВО 09.07.2025).</p>
                            <p style="margin-top: 0.75rem; color: var(--strong); font-weight: 600;">Данный аргумент в судах ещё не заявлялся.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <ul>
                                <li>Представить практику применения КС 56-П:</li>
                                <li><strong>АС ЗСО от 25.12.2024</strong></li>
                                <li><strong>АС ПО от 28.02.2025</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: No Real Damage -->
        <div class="card strong" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">2</div>
                <div class="card-title-area">
                    <div class="card-title">Отсутствие реального экологического вреда</div>
                    <div class="card-subtitle">Мониторинг ДВФУ 2008-2024 (16 лет)</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">8/10</span>
                    <span class="badge badge-court partial">Частично</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 80%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Данные мониторинга ДВФУ за <strong>16 лет</strong> показывают: здоровый бентос, нормальная фито/зоопланктон, ихтиофауна в норме. Видеосъёмка 2023: высокая продуктивность, отсутствие заиления. Заключение Галышевой: <span class="highlight">«Деятельность терминала НЕ оказывает негативного воздействия на экосистему бухты»</span>. Промысловые виды в норме, «подводные леса» 70-98% покрытия.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Прямая позиция в материалах отсутствует</li>
                                <li>Акцент на формальном нарушении ст. 56 ВК РФ (запрет сброса отходов)</li>
                                <li>Факт загрязнения подтверждён актами, протоколами, фото</li>
                                <li>Наличие последствий не является обязательным элементом состава</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка)</h4>
                            <p><strong>Не исследовалось по существу.</strong></p>
                            <div class="court-decision">
                                <span class="date">СОЮ (15.06.2023, 09.11.2023, 16.11.2023):</span> фокус на факте нарушения, а не на последствиях.
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский суд 16.10.2025:</span> довод о благополучии флоры/фауны отклонён как «несущественный для квалификации».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ХК, 6 ААС, АС ДВО по делу ВТУ:</span> экологические данные детально не анализировались.
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p><strong>Ходатайство о назначении судебной экологической экспертизы</strong> в арбитражном процессе для объективной оценки фактического состояния экосистемы.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 3: Investment Offset -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">3</div>
                <div class="card-title-area">
                    <div class="card-title">Зачёт экологических инвестиций</div>
                    <div class="card-subtitle">Инвестиции с 2023: 2 047 545 642 ₽</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">6/10</span>
                    <span class="badge badge-court no">Не заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 60%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Ветрозащитные экраны (25м × 2400м), системы пылеподавления, станция СКАТ. По <strong>п.14 Методики 87</strong> затраты на предотвращение сверхнормативного воздействия вычитаются из суммы вреда. Общий принцип: п.11 ст.16.3 ФЗ-7.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Вероятная позиция Росприроднадзора</h4>
                            <ul>
                                <li>П.14 Методики 87 — только для сбросов сточных вод (п.11), не для захламления (п.16)</li>
                                <li>Пылеподавление = обычная производственная деятельность, не компенсация вреда</li>
                                <li>Инвестиции сделаны ПОСЛЕ причинения вреда</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов</h4>
                            <p><strong>Не рассматривалось.</strong> Довод не заявлялся ни в административных делах СОЮ, ни в арбитражном деле А73-8310/2024.</p>
                            <p style="margin-top: 0.75rem;">Судебная практика по применению п.14 к п.16 Методики 87 отсутствует.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве изложено полно)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 4: Methodology Dispute -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">4</div>
                <div class="card-title-area">
                    <div class="card-title">Оспаривание методики расчёта</div>
                    <div class="card-subtitle">Коэффициент Кзагр: 6 → 1</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">5/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 50%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Кзагр=6 применяется при скоплении отходов >10 м² на 100 м² водной площади. Угольная пыль = <strong>диффузное</strong>, не очаговое загрязнение. Космоснимки: большая часть акватории НЕ покрыта. Корректный Кзагр=1 (снижение в 6 раз). П.16 Методики 87 для бытовых отходов, не пыли.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Загрязнение носит «площадной характер», простирается вглубь водного объекта</li>
                                <li>Площадь 14 589,94 м² подтверждена экспертным заключением ФГБУ ТОтехмордирекция (приёмник PrinCe i50)</li>
                                <li>Взвешенные вещества в пробах воды = проникновение пыли в толщу воды</li>
                                <li>Площадь >0,01 м² исключает Кзагр=1 по Таблице 10</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">АС ХК 15.01.2025:</span> «Площадь скопления мусора превышает 0,01 кв.м., что исключает применение коэффициента 1».
                            </div>
                            <div class="court-decision">
                                <span class="date">6 ААС 08.04.2025:</span> «Кзагр=6 обоснован тем, что загрязнение носит площадной характер».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ДВО 09.07.2025:</span> космоснимок отклонён — «невозможно достоверно установить состояние покрова 04.03, тогда как осмотр был 03.03.2023».
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: расчёт по п.17, моделирование ИСП РАН)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 5: Emission Standards -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">5</div>
                <div class="card-title-area">
                    <div class="card-title">Соблюдение нормативов выбросов</div>
                    <div class="card-subtitle">Концентрации в 10× ниже ПДК</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">5/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 50%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Проверка РПН: превышений нормативов выбросов угольной пыли НЕ установлено. Пробы воздуха: <strong>0,023-0,033 мг/м³</strong> при ПДК 0,3 мг/м³. ДТУ платит за НВОС по выбросам угольной пыли. Осаждение пыли = естественный физический процесс.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Плата НВОС = плата за атмосферные выбросы, НЕ за загрязнение воды</li>
                                <li>Ст.16 ФЗ-7: разные виды негативного воздействия</li>
                                <li>Соблюдение нормативов выбросов не освобождает от ответственности за захламление водного объекта отходами</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">Кировский суд 16.10.2025:</span> «Доводы о том, что уголь не является загрязнителем и отсутствует в перечне отходов, выбросы являются естественным процессом пыления — <strong>несостоятельны</strong>».
                            </div>
                            <p style="margin-top: 0.75rem;">Суд разграничил воздействие на атмосферу и воду как самостоятельные правонарушения.</p>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: довод о двойном взыскании)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 6: Legal Qualification -->
        <div class="card medium" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">6</div>
                <div class="card-title-area">
                    <div class="card-title">Правовая квалификация угольной пыли</div>
                    <div class="card-subtitle">Выброс ≠ отход</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">4/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 40%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Угольная пыль в Перечне загрязняющих веществ п.37(1) для воздуха, не в ФККО как самостоятельный отход. Код 6 19 111 13 71 4 — для дробления на ТЭС/ТЭЦ, не угольных терминалов.</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Ст.1 ФЗ-89: отходы = вещества, подлежащие удалению</li>
                                <li>ГОСТ 30772-2001 п.3.11: отходы = остатки, не используемые в деятельности</li>
                                <li>Приказ РПН 242: мусор при дроблении угля (код 6 19 111 13 71 4)</li>
                                <li>Распоряжение 1316-р п.166: взвешенные вещества = загрязнители воды</li>
                                <li>Морфология: угольно-песчаная смесь 99,5±29,8%, пенопласт 0,5±0,2%</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">АС ХК 06.06.2024:</span> «Угольная пыль в силу ст.1 ФЗ-89 относится к отходам производства, подлежащим удалению».
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский 23.05.2025:</span> «Угольная пыль является отходом по ФККО, V класс опасности».
                            </div>
                            <div class="court-decision">
                                <span class="date">АС ДВО 27.11.2024:</span> «Довод о том, что собранные просыпи возвращаются в техпроцесс, оставлен без оценки».
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Дополнительно к отзыву</h4>
                            <p style="color: var(--text-muted);">— (в отзыве: экспертизы МГУ, УралНИИЭкология)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 7: Procedural Violations -->
        <div class="card weak" onclick="toggleCard(this)">
            <div class="card-header">
                <div class="card-number">7</div>
                <div class="card-title-area">
                    <div class="card-title">Процедурные нарушения проверки</div>
                    <div class="card-subtitle">Согласование с ненадлежащей прокуратурой</div>
                </div>
                <div class="card-badges">
                    <span class="badge badge-strength">2/10</span>
                    <span class="badge badge-court yes">Заявлялось</span>
                </div>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="card-content">
                <div class="card-body">
                    <div class="progress-bar"><div class="fill" style="width: 20%"></div></div>
                    
                    <div class="info-grid">
                        <div class="info-section arg">
                            <h4>Суть аргумента</h4>
                            <p>Проверка согласована с Амурским бассейновым природоохранным прокурором, полномочия которого НЕ распространяются на Ванинский и Советско-Гаванский районы (Распоряжение ГП РФ от 13.06.2018 № 360/7р).</p>
                        </div>
                        
                        <div class="info-section rpn">
                            <h4>Позиция Росприроднадзора</h4>
                            <ul>
                                <li>Распоряжение ГП РФ от 16.05.2016 № 288/7р: Амурская прокуратура осуществляет надзор за ДВМУ РПН</li>
                                <li>Согласование допустимо по месту нахождения контрольного органа</li>
                                <li>Информ. письмо ГП от 09.10.2023 критикует прокурора, но НЕ отменяет результаты проверки ДТУ</li>
                            </ul>
                        </div>
                        
                        <div class="info-section court">
                            <h4>Позиция судов (мотивировка отказа)</h4>
                            <div class="court-decision">
                                <span class="date">Советско-Гаванский суд 15.06.2023, 09.11.2023, 16.11.2023:</span> «Согласование по месту нахождения надзорного органа допустимо».
                            </div>
                            <div class="court-decision">
                                <span class="date">Кировский 23.05.2025, 16.10.2025:</span> «Информ. письмо ГП не содержит указания на незаконность проверки ДТУ».
                            </div>
                            <div class="court-decision">
                                <span class="date">Хабаровский краевой суд 27.08.2025:</span> позиция нижестоящих судов подтверждена.
                            </div>
                        </div>
                        
                        <div class="info-section rec">
                            <h4>Рекомендация</h4>
                            <div class="abandon-banner">
                                <strong>✗ ОТКАЗАТЬСЯ ОТ АРГУМЕНТА</strong>
                                <p>Исчерпан во всех инстанциях. Не влияет на существо спора.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Section -->
        <div class="strategy-section">
            <h2>Итоговая стратегия</h2>
            <div class="strategy-grid">
                <div class="strategy-card priority">
                    <h3>★ ПРИОРИТЕТ</h3>
                    <p><strong>Линии 1-2:</strong> КС 56-П + данные ДВФУ = доказать отсутствие реального вреда</p>
                </div>
                <div class="strategy-card support">
                    <h3>● ПОДДЕРЖКА</h3>
                    <p><strong>Линии 3-6:</strong> Зачёт инвестиций, методика, квалификация — аргументы изложены в отзыве</p>
                </div>
                <div class="strategy-card abandon">
                    <h3>✗ ОТКАЗАТЬСЯ</h3>
                    <p><strong>Линия 7:</strong> Процедурные нарушения — многократно отклонены всеми инстанциями</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Дело № А73-19604/2025 • АО «Дальтрансуголь» • Приамурское МУ Росприроднадзора</p>
        <p style="margin-top: 0.5rem;">Потенциальное снижение: до полного отказа (линии 1-2) | минус 2 047 545 642 ₽ (линия 3)</p>
        <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.85em;">Разработчик: Кирилл Трубицын</p>
    </footer>

    <!-- Admin Button -->
    <button class="admin-fab" onclick="toggleAdmin()" aria-label="Панель администратора">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
    </button>

    <!-- Admin Modal -->
    <div class="admin-modal" id="adminModal" onclick="closeAdminOnBackdrop(event)">
        <div class="admin-panel" onclick="event.stopPropagation()">
            <div class="admin-header">
                <h2 id="adminTitle">Вход администратора</h2>
                <button class="admin-close" onclick="toggleAdmin()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-body">
                <div id="adminMessage"></div>

                <!-- Login Form -->
                <div id="adminLoginForm" class="admin-login-form">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <p>Введите пароль для доступа к загрузке документов</p>
                    <div class="admin-form-group">
                        <input type="password" class="admin-input" id="adminPassword" placeholder="Пароль" onkeypress="handleAdminKeyPress(event)">
                    </div>
                    <button class="admin-btn" onclick="adminLogin()">Войти</button>
                </div>

                <!-- Admin Content (hidden by default) -->
                <div id="adminUploadForm" style="display: none;">
                    <!-- Admin Tabs -->
                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="switchAdminTab('upload')" id="adminTabUpload">
                            Загрузка
                        </button>
                        <button class="admin-tab" onclick="switchAdminTab('documents')" id="adminTabDocuments">
                            База знаний <span id="docCountBadge" style="background: var(--primary); color: white; padding: 0.125rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                        </button>
                    </div>

                    <!-- Upload Tab Content -->
                    <div class="admin-tab-content active" id="adminUploadTabContent">
                        <!-- Drop Zone for OCR -->
                        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept="image/*,.pdf,.md,.txt,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleFileSelect(event)">
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)" style="display:none">
                            <div id="dropZoneContent">
                                <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <div class="drop-zone-text">Перетащите файл или нажмите для выбора</div>
                                <div class="drop-zone-hint">PDF, DOCX, изображения, Markdown, TXT</div>
                                <button type="button" class="camera-btn" id="cameraBtn" onclick="event.stopPropagation(); document.getElementById('cameraInput').click()">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                        <circle cx="12" cy="13" r="4"/>
                                    </svg>
                                    Сделать фото
                                </button>
                            </div>
                            <div id="processingIndicator" class="processing-indicator" style="display: none;">
                                <div class="spinner"></div>
                                <span id="processingText">ИИ распознаёт документ...</span>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="file-preview" style="display: none;">
                            <img id="previewImage" src="" alt="Preview">
                            <div class="file-preview-info">
                                <div class="file-preview-name" id="previewName"></div>
                                <div class="file-preview-size" id="previewSize"></div>
                            </div>
                            <button class="file-preview-remove" onclick="clearFile()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div class="admin-divider">или заполните вручную</div>

                        <div class="admin-form-group">
                            <label>Название документа *</label>
                            <input type="text" class="admin-input" id="docTitle" placeholder="Например: Договор поставки №123">
                        </div>
                        <div class="admin-form-group">
                            <label>Содержимое документа *</label>
                            <textarea class="admin-textarea" id="docContent" placeholder="Вставьте текст документа или загрузите файл для OCR..."></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label>Источник</label>
                            <input type="text" class="admin-input" id="docSource" placeholder="Например: Приложение к делу №5">
                        </div>
                        <div class="admin-form-group">
                            <label>Категория</label>
                            <select class="admin-select" id="docCategory">
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт (решение, определение)</option>
                                <option value="процессуальный_документ">Процессуальный документ (иск, отзыв, ходатайство)</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                        </div>
                        <button class="admin-btn" id="uploadBtn" onclick="uploadDocument()">Загрузить документ в базу знаний</button>
                    </div>

                    <!-- Documents Tab Content -->
                    <div class="admin-tab-content" id="adminDocsTabContent">
                        <!-- Stats -->
                        <div class="doc-stats">
                            <div>
                                <div class="doc-stats-total" id="totalDocsCount">0</div>
                                <div class="doc-stats-label">документов в базе</div>
                            </div>
                        </div>

                        <!-- Category Filter -->
                        <div class="doc-filter" style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="docFilterCategory" onchange="loadDocuments()" style="flex: 1;">
                                <option value="all">Все категории</option>
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт</option>
                                <option value="процессуальный_документ">Процессуальный документ</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                            <button onclick="deleteAllDocuments()" style="background: #e53e3e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; white-space: nowrap;">Удалить все</button>
                        </div>

                        <!-- Document List -->
                        <div class="doc-list" id="docList">
                            <div class="doc-loading">Загрузка документов...</div>
                        </div>

                        <!-- Pagination -->
                        <div class="doc-pagination" id="docPagination" style="display: none;">
                            <button onclick="changePage(-1)" id="prevPageBtn">← Назад</button>
                            <span id="pageInfo">1 / 1</span>
                            <button onclick="changePage(1)" id="nextPageBtn">Вперёд →</button>
                        </div>
                    </div>

                    <button class="admin-btn" style="margin-top: 0.75rem; background: linear-gradient(135deg, #718096 0%, #4a5568 100%);" onclick="adminLogout()">Выйти</button>
                </div>

                <!-- Edit Document Modal -->
                <div class="edit-modal" id="editModal" onclick="closeEditModal(event)">
                    <div class="edit-modal-content" onclick="event.stopPropagation()">
                        <div class="edit-modal-header">
                            <h3>Редактирование документа</h3>
                            <button class="admin-close" onclick="closeEditModal()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <input type="hidden" id="editDocId">
                        <div class="admin-form-group">
                            <label>Название</label>
                            <input type="text" class="admin-input" id="editDocTitle">
                        </div>
                        <div class="admin-form-group">
                            <label>Содержимое</label>
                            <textarea class="admin-textarea" id="editDocContent" style="min-height: 200px;"></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label>Источник</label>
                            <input type="text" class="admin-input" id="editDocSource">
                        </div>
                        <div class="admin-form-group">
                            <label>Категория</label>
                            <select class="admin-select" id="editDocCategory">
                                <option value="документ">Документ</option>
                                <option value="договор">Договор</option>
                                <option value="акт">Акт</option>
                                <option value="переписка">Переписка</option>
                                <option value="заключение">Экспертное заключение</option>
                                <option value="судебный_акт">Судебный акт</option>
                                <option value="процессуальный_документ">Процессуальный документ</option>
                                <option value="нормативный_акт">Нормативный акт</option>
                                <option value="отчет">Отчёт/Мониторинг</option>
                                <option value="справка_ии">Юридическая справка от ИИ</option>
                            </select>
                        </div>
                        <button class="admin-btn" onclick="saveDocument()">Сохранить изменения</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Timeline Tab Content -->
    <div class="main-tab-content active" id="timelineContent">
        <div class="timeline-layout">

            <!-- Calendar Sidebar -->
            <aside class="timeline-sidebar">
                <nav class="calendar-nav">
                    <div class="calendar-header">Навигация по датам</div>

                    <!-- Color Legend -->
                    <div class="calendar-legend">
                        <div class="calendar-legend-title">Обозначения</div>
                        <div class="calendar-legend-item">
                            <span class="calendar-legend-dot positive"></span>
                            <span>Положительное событие (успех защиты)</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="calendar-legend-dot negative"></span>
                            <span>Негативное событие (решение против)</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="calendar-legend-dot neutral"></span>
                            <span>Нейтральное событие</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="calendar-legend-dot key"></span>
                            <span>Ключевое событие</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="calendar-legend-dot upcoming"></span>
                            <span>Предстоящее событие</span>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="timeline-filters">
                        <div class="timeline-filters-title">Фильтры</div>
                        <div class="timeline-filter-buttons">
                            <button class="timeline-filter-btn active" data-filter="all" onclick="filterTimeline('all')">
                                Все
                            </button>
                            <button class="timeline-filter-btn" data-filter="key" onclick="filterTimeline('key')">
                                <span class="filter-dot key"></span>
                                Ключевые
                            </button>
                            <button class="timeline-filter-btn" data-filter="positive" onclick="filterTimeline('positive')">
                                <span class="filter-dot positive"></span>
                                Успехи
                            </button>
                            <button class="timeline-filter-btn" data-filter="negative" onclick="filterTimeline('negative')">
                                <span class="filter-dot negative"></span>
                                Неудачи
                            </button>
                        </div>
                    </div>

                    <!-- Years Navigation -->
                    <div class="calendar-years">

                        <!-- 2021 -->
                        <div class="calendar-year collapsed">
                            <div class="calendar-year-header" onclick="toggleCalendarYear(this)">
                                <span class="year-label">2021</span>
                                <div class="event-dots">
                                    <span class="dot" style="background: var(--strong)"></span>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="calendar-year-events">
                                <div class="calendar-event" onclick="scrollToEvent('event-2021-07-21')">
                                    <span class="event-dot positive"></span>
                                    <span class="event-date">21.07</span>
                                    <span class="event-title">Заключение ГЭЭ</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2023 -->
                        <div class="calendar-year collapsed">
                            <div class="calendar-year-header" onclick="toggleCalendarYear(this)">
                                <span class="year-label">2023</span>
                                <div class="event-dots">
                                    <span class="dot" style="background: var(--weak)"></span>
                                    <span class="dot" style="background: var(--strong)"></span>
                                    <span class="dot" style="background: var(--accent-gold)"></span>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="calendar-year-events">
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-01-24')">
                                    <span class="event-dot neutral"></span>
                                    <span class="event-date">24.01</span>
                                    <span class="event-title">Обращение гражданина</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-02-08')">
                                    <span class="event-dot negative"></span>
                                    <span class="event-date">08.02</span>
                                    <span class="event-title">Выездное обследование</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-02-21')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">21.02</span>
                                    <span class="event-title">Решение о проверке</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-03-01')">
                                    <span class="event-dot negative"></span>
                                    <span class="event-date">01.03</span>
                                    <span class="event-title">Начало проверки</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-03-20')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">20.03</span>
                                    <span class="event-title">Площадь загрязнения</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-03-23')">
                                    <span class="event-dot negative"></span>
                                    <span class="event-date">23.03</span>
                                    <span class="event-title">Акт проверки</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-06-15')">
                                    <span class="event-dot positive"></span>
                                    <span class="event-date">15.06</span>
                                    <span class="event-title">Отмена постановления</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-07-18')">
                                    <span class="event-dot positive"></span>
                                    <span class="event-date">18.07</span>
                                    <span class="event-title">УралНИИ: пыль ≠ отход</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2023-10-09')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">09.10</span>
                                    <span class="event-title">Письмо Генпрокуратуры</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2024 -->
                        <div class="calendar-year collapsed">
                            <div class="calendar-year-header" onclick="toggleCalendarYear(this)">
                                <span class="year-label">2024</span>
                                <div class="event-dots">
                                    <span class="dot" style="background: var(--weak)"></span>
                                    <span class="dot" style="background: var(--accent-gold)"></span>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="calendar-year-events">
                                <div class="calendar-event" onclick="scrollToEvent('event-2024-02-06')">
                                    <span class="event-dot negative"></span>
                                    <span class="event-date">06.02</span>
                                    <span class="event-title">Итоговые штрафы</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2024-12-06')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">06.12</span>
                                    <span class="event-title">Постановление КС РФ</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2025 -->
                        <div class="calendar-year">
                            <div class="calendar-year-header" onclick="toggleCalendarYear(this)">
                                <span class="year-label">2025</span>
                                <div class="event-dots">
                                    <span class="dot" style="background: var(--accent-gold)"></span>
                                    <span class="dot" style="background: var(--strong)"></span>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="calendar-year-events">
                                <div class="calendar-event" onclick="scrollToEvent('event-2025-05-23')">
                                    <span class="event-dot positive"></span>
                                    <span class="event-date">23.05</span>
                                    <span class="event-title">Снижение штрафа</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2025-10-17')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">17.10</span>
                                    <span class="event-title">Претензия 2,5 млрд</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2025-11-19')">
                                    <span class="event-dot key"></span>
                                    <span class="event-date">19.11</span>
                                    <span class="event-title">Иск Росприроднадзора</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2025-12-10')">
                                    <span class="event-dot positive"></span>
                                    <span class="event-date">10.12</span>
                                    <span class="event-title">Минтранс: нет технологий</span>
                                </div>
                                <div class="calendar-event" onclick="scrollToEvent('event-2025-12-23')">
                                    <span class="event-dot neutral"></span>
                                    <span class="event-date">23.12</span>
                                    <span class="event-title">Предв. заседание</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2026 -->
                        <div class="calendar-year">
                            <div class="calendar-year-header" onclick="toggleCalendarYear(this)">
                                <span class="year-label">2026</span>
                                <div class="event-dots">
                                    <span class="dot" style="background: #6366f1"></span>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="calendar-year-events">
                                <div class="calendar-event" onclick="scrollToEvent('event-2026-01-22')">
                                    <span class="event-dot upcoming"></span>
                                    <span class="event-date">22.01</span>
                                    <span class="event-title">Суд. заседание</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </nav>
            </aside>

            <!-- Main Timeline Content -->
            <main class="timeline-main">

            <!-- Section I -->
            <div class="timeline-section collapsed">
                <div class="timeline-section-header" onclick="toggleTimelineSection(this)">
                    <span>I. Период стабильной деятельности (2008–2022)</span>
                    <span class="event-count">2 события</span>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="timeline-section-body">
                    <div class="timeline">

                        <div class="timeline-item key">
                            <div class="timeline-card">
                                <div class="timeline-card-header" onclick="toggleTimelineItem(this)">
                                    <span class="timeline-date">2008 — 2024 гг.</span>
                                    <div class="timeline-title">Многолетний экологический мониторинг экосистемы бухты Мучке</div>
                                    <div class="timeline-card-toggle">
                                        <span>Подробнее</span>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="timeline-card-body">
                                    <div class="timeline-description">
                                        На протяжении более чем 16 лет Дальневосточный федеральный университет (ДВФУ) проводил систематический мониторинг экологического состояния водных биологических ресурсов в зоне воздействия угольного терминала АО «Дальтрансуголь». Исследования включали бентосные съёмки, подводную видеосъёмку, анализ состояния зообентоса, фитобентоса и макрозообентоса. По результатам всех исследований установлено благополучное состояние донных ценозов и отсутствие негативного влияния терминала на водные биоресурсы.
                                    </div>
                                    <div class="timeline-significance">
                                        <div class="timeline-significance-label">Значение</div>
                                        <div class="timeline-significance-text">Ключевое доказательство отсутствия реального экологического вреда. Данные мониторинга опровергают презумпцию причинения вреда экосистеме и служат основанием для применения Постановления КС РФ № 56-П.</div>
                                    </div>
                                    <div class="timeline-docs">
                                        <div class="timeline-docs-label">Документы:</div>
                                        <ul class="timeline-docs-list">
                                            <li>Отчет о НИР по данным бентосной съемки апрель 2023 г.pdf</li>
                                            <li>Экспертное заключение ДВФУ по результатам анализа данных отчетов о НИР за 2008-2020 гг.</li>
                                            <li>Экспертное заключение ДВФУ по результатам исследования отчетов о НИР за 2024 г.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="timeline-item positive" id="event-2021-07-21">
                            <div class="timeline-card">
                                <div class="timeline-card-header" onclick="toggleTimelineItem(this)">
                                    <span class="timeline-date">21 июля 2021 г.</span>
                                    <div class="timeline-title">Положительное заключение государственной экологической экспертизы № 291-О</div>
                                    <div class="timeline-card-toggle">
                                        <span>Подробнее</span>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="timeline-card-body">
                                    <div class="timeline-description">
                                        Утверждено положительное заключение государственной экологической экспертизы на деятельность АО «Дальтрансуголь» с объёмом перевалки до 24 млн тонн угля в год. Экспертиза подтвердила соответствие деятельности предприятия требованиям природоохранного законодательства. В документации отражены меры по охране окружающей среды: системы пылеподавления с проектной эффективностью очистки 99%, ветрозащитные ограждения, системы очистки сточных вод.
                                    </div>
                                    <div class="timeline-significance">
                                        <div class="timeline-significance-label">Значение</div>
                                        <div class="timeline-significance-text">Подтверждает легитимность хозяйственной деятельности в утверждённых пределах. Деятельность в рамках согласованных нормативов не может служить основанием для возмещения вреда.</div>
                                    </div>
                                    <div class="timeline-docs">
                                        <div class="timeline-docs-label">Документы:</div>
                                        <ul class="timeline-docs-list">
                                            <li>Заключение ГЭЭ № 291-О от 21.07.2021</li>
                                            <li>Проекты нормативов допустимых выбросов (4 тома)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Section II -->
            <div class="timeline-section collapsed">
                <div class="timeline-section-header" onclick="toggleTimelineSection(this)">
                    <span>II. 2023 год: Проверки и начало правового конфликта</span>
                    <span class="event-count">18 событий</span>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="timeline-section-body">
                    <div class="timeline">

                    <div class="timeline-item neutral" id="event-2023-01-24">
                        <div class="timeline-card">
                            <span class="timeline-date">24 января 2023 г.</span>
                            <div class="timeline-title">Обращение гражданина — основание для надзорных мероприятий</div>
                            <div class="timeline-description">
                                Поступило обращение гражданина о загрязнении угольной пылью в посёлке Токи Ванинского района. Данное обращение послужило формальным основанием для инициирования надзорных мероприятий Дальневосточным межрегиональным управлением Росприроднадзора в отношении АО «Дальтрансуголь».
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Отправная точка всех последующих проверок и судебных разбирательств.</div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-02-08">
                        <div class="timeline-card">
                            <span class="timeline-date">8 февраля 2023 г.</span>
                            <div class="timeline-title">Выездное обследование акватории без взаимодействия с контролируемым лицом</div>
                            <div class="timeline-description">
                                Росприроднадзор провёл выездное обследование акватории бухты Мучке без взаимодействия с АО «Дальтрансуголь» (№ 16-04-02/2023-В). В ходе обследования специалистами ФГБУ «ЦЛАТИ по ДФО» произведён отбор проб морской воды. По результатам лабораторных исследований (протокол испытаний от 13.02.2023 № 32/1, № 33/1, экспертное заключение от 13.02.2023 № 016/2023) зафиксировано превышение ПДК по взвешенным веществам в пробах воды.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Результаты этого обследования легли в основу последующего решения о проведении внеплановой проверки.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Акт выездного обследования № 16-04-02/2023-В от 08.02.2023</li>
                                    <li>Экспертное заключение ФГБУ «ЦЛАТИ по ДФО» от 13.02.2023 № 016/2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-02-21-exp">
                        <div class="timeline-card">
                            <span class="timeline-date">21 февраля 2023 г.</span>
                            <div class="timeline-title">Экспертное заключение ЦЛАТИ № 037/2023</div>
                            <div class="timeline-description">
                                ФГБУ «ЦЛАТИ по ДФО» подготовило экспертное заключение № 037/2023, подтверждающее превышение концентрации взвешенных веществ в пробах воды акватории бухты Мучке по сравнению с фоновыми показателями.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Основание для принятия решения о проведении внеплановой проверки.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Экспертное заключение от 21.02.2023 № 037/2023 (2 л.)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2023-02-21">
                        <div class="timeline-card">
                            <span class="timeline-date">21–22 февраля 2023 г.</span>
                            <div class="timeline-title">Решение о проведении внеплановой выездной проверки</div>
                            <div class="timeline-description">
                                Росприроднадзор принял решение № 26-КНД от 21.02.2023 о проведении внеплановой выездной проверки в отношении АО «Дальтрансуголь». 22.02.2023 проверка была согласована с первым заместителем Амурского бассейнового природоохранного прокурора. <strong>Позиция защиты:</strong> согласование проведено с ненадлежащим прокурором, поскольку территория Ванинского района не входит в компетенцию Амурской бассейновой прокуратуры согласно распоряжению Генпрокуратуры от 13.06.2018 № 360/7р.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Ключевой процессуальный вопрос о законности проверки. Согласно позиции Генеральной прокуратуры (письмо от 09.10.2023), согласование было проведено с нарушениями.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение № 26-КНД от 21.02.2023</li>
                                    <li>Согласование с прокурором от 22.02.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-03-01">
                        <div class="timeline-card">
                            <span class="timeline-date">1 марта 2023 г.</span>
                            <div class="timeline-title">Начало внеплановой выездной проверки. Осмотр территории</div>
                            <div class="timeline-description">
                                Начался основной этап внеплановой выездной проверки АО «Дальтрансуголь». В ходе осмотра производственной территории зафиксировано: (1) на пирсе № 5 вдоль конвейерной линии — просыпи угля и угольной крошки; (2) ледовый покров бухты Мучке от мыса Бурный до мыса Мучукей-Дуа имеет чёрный цвет от загрязнения угольной пылью; (3) береговая полоса загрязнена угольной пылью, камни засыпаны пылью слоем до 5 см; (4) снегогенераторы работали не на всех складах; (5) отсутствие инженерных сооружений для сбора ливневых и талых вод вдоль автодороги.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Основные фактические обстоятельства, положенные в основу административного и гражданского дела.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Протокол осмотра от 01.03.2023 № 3 с фототаблицей</li>
                                    <li>Видеозапись осмотра от 01.03.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2023-03-02">
                        <div class="timeline-card">
                            <span class="timeline-date">2 марта 2023 г.</span>
                            <div class="timeline-title">Отбор проб и акт о невозможности отбора проб с ледового покрытия</div>
                            <div class="timeline-description">
                                Специалистами ФГБУ «ЦЛАТИ по ДФО» произведён отбор проб природной воды бухты Мучке вдоль пирса № 5 (протокол отбора № 3/56), а также проб отходов производства. Составлен Акт № 1/25 о невозможности проведения отбора проб непосредственно с ледового покрытия. По результатам испытаний (протокол от 09.03.2023 № 56/1) установлены превышения по взвешенным веществам: в пробе № 1 — в 1,9 раза, в пробах № 2 и № 4 — в 1,1 раза относительно фоновой пробы № 3.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Акт о невозможности отбора проб с ледового покрытия ставит под сомнение достоверность определения площади загрязнения.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Протокол отбора проб от 02.03.2023 № 3/56</li>
                                    <li>Акт № 1/25 о невозможности отбора проб с ледового покрытия от 02.03.2023 (2 л.)</li>
                                    <li>Экспертное заключение ФГБУ «ЦЛАТИ по ДФО» от 10.03.2023 № 025/2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2023-03-20">
                        <div class="timeline-card">
                            <span class="timeline-date">20 марта 2023 г.</span>
                            <div class="timeline-title">Экспертное заключение ФГБУ «ТОтехмордирекция» № 3 о площади загрязнения</div>
                            <div class="timeline-description">
                                ФГБУ «Тихоокеанская дирекция по техническому обеспечению надзора на море» (ТОтехмордирекция) подготовило экспертное заключение № 3, установив площадь загрязнения прибрежного льда в акватории Татарского пролива в размере 118 463,33 кв. м. Координаты определены от мыса Бурный до мыса Мучукей-Дуа и далее до пирса АО «Дальтрансуголь». <strong>Позиция защиты:</strong> (1) отсутствуют доказательства фактического использования приёмника Prin Ce i50; (2) карта-схема наложена на космоснимок летнего периода; (3) не проводилось инструментальное обследование согласно ст. 82 Закона № 248-ФЗ.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Ключевой документ для расчёта размера вреда. Достоверность определения площади — центральный вопрос спора.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Экспертное заключение ФГБУ «ТОтехмордирекция» от 20.03.2023 № 3</li>
                                    <li>Схема координат площади загрязнения</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-03-23">
                        <div class="timeline-card">
                            <span class="timeline-date">23 марта 2023 г.</span>
                            <div class="timeline-title">Завершение внеплановой выездной проверки. Акт проверки № 16-04/26-КНД</div>
                            <div class="timeline-description">
                                Завершена внеплановая выездная проверка. Составлен Акт проверки № 16-04/26-КНД с приложениями. Установлены нарушения: ч. 1, 2 ст. 39, ст. 55, ч. 1 ст. 58, ч. 1 ст. 65, пп. 2 ч. 15 ст. 65, ч. 16 ст. 65 Водного кодекса РФ; ст. 1, п. 1 ст. 34, ст. 37, 39, п. 1 ст. 51, ст. 34 ФЗ «Об охране окружающей среды»; ст. 1, п. 1 ст. 20, ст. 13.4 ФЗ «Об отходах производства и потребления».
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Основной документ, фиксирующий результаты проверки и послуживший основанием для административного и гражданского преследования.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Акт выездной проверки от 23.03.2023 № 16-04/26-КНД (с приложениями)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-04-11">
                        <div class="timeline-card">
                            <span class="timeline-date">11 апреля 2023 г.</span>
                            <div class="timeline-title">Первое постановление о наложении штрафа на АО «Дальтрансуголь»</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес постановление о привлечении АО «Дальтрансуголь» к административной ответственности по ч. 1 ст. 8.45 КоАП РФ (невыполнение требований по оборудованию объектов, расположенных в водоохранных зонах, сооружениями для охраны водных объектов) с назначением штрафа в размере 1 000 000 рублей.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Первая попытка привлечения к административной ответственности, впоследствии отменённая судом.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление о назначении адм. наказания от 11.04.2023 (АО «Дальтрансуголь»)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-06-01">
                        <div class="timeline-card">
                            <span class="timeline-date">1 июня 2023 г.</span>
                            <div class="timeline-title">Постановление о наложении штрафа на АО «НТК» (управляющая организация)</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес постановление о привлечении АО «Национальная транспортная компания» (управляющая организация АО «Дальтрансуголь») к административной ответственности с назначением штрафа в размере 1 000 000 рублей.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Параллельное привлечение к ответственности управляющей организации.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление о назначении НТК адм. наказания от 01.06.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2023-06-15">
                        <div class="timeline-card">
                            <span class="timeline-date">15 июня 2023 г.</span>
                            <div class="timeline-title">Советско-Гаванский городской суд отменяет апрельское постановление в отношении ДТУ</div>
                            <div class="timeline-description">
                                Советско-Гаванский городской суд Хабаровского края отменил постановление Росприроднадзора от 11.04.2023 в отношении АО «Дальтрансуголь» в связи с процессуальными нарушениями, допущенными при производстве по делу об административном правонарушении. Дело направлено на новое рассмотрение в Росприроднадзор.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Первая успешная отмена постановления, подтвердившая наличие процессуальных нарушений.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Советско-Гаванского городского суда от 15.06.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2023-07-13">
                        <div class="timeline-card">
                            <span class="timeline-date">13 июля 2023 г.</span>
                            <div class="timeline-title">РПН выносит определение об объединении дел в отношении ДТУ в одно производство</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес определение об объединении административных дел в отношении АО «Дальтрансуголь» в одно производство для совместного рассмотрения.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Консолидация административных дел для единого производства.</div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2023-07-18">
                        <div class="timeline-card">
                            <span class="timeline-date">18 июля 2023 г.</span>
                            <div class="timeline-title">Письмо ФГБУ УралНИИ «Экология» о квалификации угольной пыли</div>
                            <div class="timeline-description">
                                ФГБУ УралНИИ «Экология» направило письмо № 01-08/258, в котором указало, что осевшая угольная пыль не может быть квалифицирована как отход производства и потребления. Пыль, оседающая из атмосферного воздуха, представляет собой результат естественного физического процесса гравитационного осаждения выбросов загрязняющих веществ в атмосферу, а не целенаправленный сброс отходов.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Ключевой аргумент защиты: угольная пыль — это атмосферные выбросы, а не отходы. Квалификация определяет применимую методику расчёта вреда.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Письмо ФГБУ УралНИИ «Экология» от 18.07.2023 № 01-08/258</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-07-26">
                        <div class="timeline-card">
                            <span class="timeline-date">26 июля 2023 г.</span>
                            <div class="timeline-title">Повторное постановление Росприроднадзора в отношении АО «Дальтрансуголь»</div>
                            <div class="timeline-description">
                                После возврата дела Росприроднадзор вынес новое постановление о привлечении АО «Дальтрансуголь» к административной ответственности с назначением штрафа в размере 1 000 000 рублей. В постановлении объединены составы правонарушений по нескольким статьям КоАП РФ.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Повторная попытка привлечения к ответственности, также впоследствии отменённая.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление о назначении адм. наказания от 26.07.2023 (АО «Дальтрансуголь»)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2023-08-15">
                        <div class="timeline-card">
                            <span class="timeline-date">15 августа 2023 г.</span>
                            <div class="timeline-title">Советско-Гаванский городской суд отменяет июньское постановление в отношении НТК</div>
                            <div class="timeline-description">
                                Советско-Гаванский городской суд Хабаровского края отменил постановление Росприроднадзора от 01.06.2023 в отношении АО «НТК» и направил дело на новое рассмотрение.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Аналогичная отмена постановления в отношении управляющей организации.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Советско-Гаванского городского суда от 15.08.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2023-09-04">
                        <div class="timeline-card">
                            <span class="timeline-date">4 сентября 2023 г.</span>
                            <div class="timeline-title">РПН объединяет административные дела в отношении АО «НТК»</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес определение об объединении административных дел в отношении АО «НТК» в одно производство для совместного рассмотрения.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Консолидация административных дел для единого производства по НТК.</div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2023-09-12">
                        <div class="timeline-card">
                            <span class="timeline-date">12 сентября 2023 г.</span>
                            <div class="timeline-title">Повторное постановление Росприроднадзора в отношении АО «НТК»</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес новое постановление о привлечении АО «НТК» к административной ответственности с назначением штрафа в размере 1 000 000 рублей.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Вторая попытка привлечения НТК к административной ответственности.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление о назначении НТК адм. наказания от 12.09.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2023-10-09">
                        <div class="timeline-card">
                            <span class="timeline-date">9 октября 2023 г.</span>
                            <div class="timeline-title">Информационное письмо Генеральной прокуратуры РФ</div>
                            <div class="timeline-description">
                                Генеральная прокуратура Российской Федерации направила информационное письмо № 203дсп, в котором дала критическую оценку действиям первого заместителя Амурского бассейнового природоохранного прокурора при согласовании проведения внеплановой выездной проверки в отношении АО «Дальтрансуголь». Указано, что согласование проведено с нарушением территориальной компетенции.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Официальное подтверждение процессуальных нарушений на высшем прокурорском уровне. Может служить основанием для признания результатов проверки недопустимыми доказательствами.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Информационное письмо Генеральной прокуратуры от 09.10.2023 № 203дсп (4 л.)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2023-11-09">
                        <div class="timeline-card">
                            <span class="timeline-date">9 ноября 2023 г.</span>
                            <div class="timeline-title">Советско-Гаванский городской суд отменяет постановление от 26.07.2023 в отношении ДТУ</div>
                            <div class="timeline-description">
                                Советско-Гаванский городской суд Хабаровского края вновь отменил постановление Росприроднадзора от 26.07.2023 в отношении АО «Дальтрансуголь» и направил дело на новое рассмотрение (дело № 12-188/2023).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Вторая отмена постановления. Свидетельствует о системных процессуальных нарушениях.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Советско-Гаванского городского суда от 09.11.2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2023-11-16">
                        <div class="timeline-card">
                            <span class="timeline-date">16 ноября 2023 г.</span>
                            <div class="timeline-title">Советско-Гаванский городской суд отменяет сентябрьское постановление в отношении НТК</div>
                            <div class="timeline-description">
                                Советско-Гаванский городской суд Хабаровского края отменил постановление Росприроднадзора от 12.09.2023 в отношении АО «НТК» (дело № 12-206/2023).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Вторая отмена постановления в рамках административного преследования НТК.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Советско-Гаванского городского суда от 16.11.2023 по делу № 12-206/2023</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
            </div>

            <!-- Section III -->
            <div class="timeline-section collapsed">
                <div class="timeline-section-header" onclick="toggleTimelineSection(this)">
                    <span>III. 2024 год: Закрепление штрафов и судебная карусель</span>
                    <span class="event-count">7 событий</span>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="timeline-section-body">
                    <div class="timeline">

                    <div class="timeline-item negative" id="event-2024-02-06">
                        <div class="timeline-card">
                            <span class="timeline-date">6 февраля 2024 г.</span>
                            <div class="timeline-title">Итоговые постановления Росприроднадзора о штрафах для ДТУ и НТК</div>
                            <div class="timeline-description">
                                Росприроднадзор вынес итоговые постановления № 18-13/01/01-2024 и № 18-13/01/02-2024, объединив несколько составов административных правонарушений (ч. 1 ст. 8.2, ст. 8.5, ч. 4 ст. 8.13, ч. 5 ст. 8.13, ч. 1 ст. 8.45 КоАП РФ) и назначив АО «Дальтрансуголь» и АО «НТК» штрафы по 1 000 000 рублей каждому. Применена ст. 4.4 КоАП РФ о назначении наказания в пределах санкции с наибольшим штрафом.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Окончательные постановления, впоследствии ставшие предметом судебного обжалования.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление о назначении адм. наказания АО «Дальтрансуголь» от 06.02.2024 № 18-13/01/01-2024</li>
                                    <li>Постановление о назначении адм. наказания АО «НТК» от 06.02.2024 № 18-13/01/02-2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2024-03-15">
                        <div class="timeline-card">
                            <span class="timeline-date">15 марта 2024 г.</span>
                            <div class="timeline-title">Хабаровский краевой суд отменяет решение от 30.11.2023 по предписанию</div>
                            <div class="timeline-description">
                                Судебная коллегия Хабаровского краевого суда отменила решение Советско-Гаванского городского суда от 30.11.2023 по делу № 2а-699/2023 и направила дело в первую инстанцию на новое рассмотрение. Основание: ненадлежащее извещение сторон — стороны были извещены по телефону за день до суда, а РПН не был уведомлён надлежащим образом.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Отмена негативного решения по процессуальным основаниям. Подтверждает грубые нарушения в рассмотрении дела.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Апелляционное определение Хабаровского краевого суда от 15.03.2024 № 33а-1680/2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2024-05-13">
                        <div class="timeline-card">
                            <span class="timeline-date">13 мая 2024 г.</span>
                            <div class="timeline-title">Арбитражный суд Московской области передаёт дело АО «НТК» по подсудности</div>
                            <div class="timeline-description">
                                Арбитражный суд Московской области вынес определение по делу № А41-14233/2024 о передаче дела об оспаривании постановления Росприроднадзора от 06.02.2024 в отношении АО «НТК» в Московский областной суд (суд общей юрисдикции) в соответствии с правилами о подсудности.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Определение подсудности спора об административном штрафе для управляющей организации.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Определение АС Московской области от 13.05.2024 по делу № А41-14233/2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2024-05-22">
                        <div class="timeline-card">
                            <span class="timeline-date">22 мая 2024 г.</span>
                            <div class="timeline-title">Арбитражный суд Хабаровского края передаёт дело об оспаривании штрафа в суд общей юрисдикции</div>
                            <div class="timeline-description">
                                Арбитражный суд Хабаровского края вынес определение по делу № А73-2574/2024 о передаче дела об оспаривании постановления Росприроднадзора от 06.02.2024 № 18-13/02/02-2024 в Хабаровский краевой суд для направления в суд общей юрисдикции, к подсудности которого оно отнесено законом. Суд учёл, что ранее аналогичные постановления о привлечении общества к административной ответственности были оспорены и рассмотрены судом общей юрисдикции.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Определение подсудности спора об административном штрафе.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Определение АС Хабаровского края от 22.05.2024 по делу № А73-2574/2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2024-05-31">
                        <div class="timeline-card">
                            <span class="timeline-date">31 мая 2024 г.</span>
                            <div class="timeline-title">Советско-Гаванский городской суд отклоняет иск АО «Дальтрансуголь» об оспаривании предписания (дело № 2а-1042/2024)</div>
                            <div class="timeline-description">
                                Советско-Гаванский городской суд Хабаровского края (судья Анохина В.А.) отказал АО «Дальтрансуголь» в удовлетворении административного иска об оспаривании предписания Росприроднадзора № 16-04/26-КНД-П от 23.03.2023. Суд признал предписание законным, обоснованным и исполнимым. Отклонены доводы о процессуальных нарушениях при проведении проверки (согласование с прокуратурой), об отсутствии загрязнения угольной пылью и о неисполнимости предписания. Суд установил, что загрязнение ледового покрова бухты Мучке угольной пылью подтверждено экспертными исследованиями ФГБУ «ЦЛАТИ по ДФО».
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Первая инстанция признала предписание законным. Негативный прецедент для основного дела о возмещении вреда.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Советско-Гаванского городского суда от 31.05.2024 по делу № 2а-1042/2024 (УИД 27RS0014-01-2023-000823-11)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item vtu" id="event-2024-06-21">
                        <div class="timeline-card">
                            <span class="timeline-date">21 июня 2024 г.</span>
                            <div class="timeline-title">Арбитражный суд Хабаровского края подтверждает законность предписания в отношении АО «ВаниноТрансУголь»</div>
                            <div class="timeline-description">
                                Арбитражный суд Хабаровского края вынес решение по делу № А73-14401/2023, подтвердив законность предписания Росприроднадзора № 16-04/27-КНД-П от 24.03.2023 в отношении АО «ВаниноТрансУголь». Суд отклонил доводы о процессуальных нарушениях при проведении проверки и согласовании с прокурором.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Прецедентное решение первой инстанции по аналогичному делу ВТУ.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение АС Хабаровского края от 21.06.2024 по делу № А73-14401/2023 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item vtu" id="event-2024-09-25">
                        <div class="timeline-card">
                            <span class="timeline-date">25 сентября 2024 г.</span>
                            <div class="timeline-title">Шестой арбитражный апелляционный суд подтверждает законность предписания ВТУ</div>
                            <div class="timeline-description">
                                Шестой арбитражный апелляционный суд оставил без изменения решение АС Хабаровского края от 21.06.2024 о законности предписания Росприроднадзора в отношении АО «ВаниноТрансУголь» (дело № А73-14401/2023). Апелляционная инстанция подтвердила выводы суда первой инстанции.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Апелляционное подтверждение законности предписания по делу ВТУ.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление 6 ААС от 25.09.2024 по делу № А73-14401/2023 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2024-10-01">
                        <div class="timeline-card">
                            <span class="timeline-date">1 октября 2024 г.</span>
                            <div class="timeline-title">Кировский районный суд г. Хабаровска признаёт законным штраф для АО «НТК»</div>
                            <div class="timeline-description">
                                Кировский районный суд г. Хабаровска отказал АО «НТК» в удовлетворении жалобы на постановление Росприроднадзора от 06.02.2024, признав штраф в размере 1 000 000 рублей законным и обоснованным (дело № 12-1326/2024).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Подтверждение законности административного штрафа для управляющей организации.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Кировского районного суда г. Хабаровска от 01.10.2024 по делу № 12-1326/2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item vtu" id="event-2024-12-05">
                        <div class="timeline-card">
                            <span class="timeline-date">5 декабря 2024 г.</span>
                            <div class="timeline-title">Арбитражный суд Дальневосточного округа подтверждает законность предписания ВТУ</div>
                            <div class="timeline-description">
                                Арбитражный суд Дальневосточного округа отклонил кассационную жалобу АО «ВаниноТрансУголь» по делу № А73-14401/2023 о законности предписания № 16-04/27-КНД-П, окончательно подтвердив его законность на кассационном уровне. Данное дело имеет прецедентное значение для спора АО «Дальтрансуголь», поскольку касается аналогичных обстоятельств.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Прецедентное решение по аналогичному делу ВТУ. Три инстанции признали предписание законным.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление АС Дальневосточного округа от 05.12.2024 по делу № А73-14401/2023 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2024-12-06">
                        <div class="timeline-card">
                            <span class="timeline-date">6 декабря 2024 г.</span>
                            <div class="timeline-title">Постановление Конституционного Суда РФ № 56-П</div>
                            <div class="timeline-description">
                                Конституционный Суд Российской Федерации вынес Постановление № 56-П, установив, что определение размера возмещаемого вреда окружающей среде не должно основываться исключительно на формальном применении методик расчёта. Суд при рассмотрении иска о возмещении вреда не может ограничиваться констатацией состава правонарушения и должен учитывать обстоятельства, исключающие или существенно снижающие вредоносность нарушения.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text"><strong>КЛЮЧЕВОЕ СОБЫТИЕ.</strong> Создаёт правовую основу для снижения или полного отказа во взыскании при доказанном отсутствии реального экологического вреда.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление КС РФ от 06.12.2024 № 56-П</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2024-12-12">
                        <div class="timeline-card">
                            <span class="timeline-date">12 декабря 2024 г.</span>
                            <div class="timeline-title">Хабаровский краевой суд возвращает жалобу АО «НТК» без рассмотрения</div>
                            <div class="timeline-description">
                                Хабаровский краевой суд вернул апелляционную жалобу АО «НТК» на решение Кировского районного суда без рассмотрения в связи с тем, что представителем не была представлена доверенность, подтверждающая право на передоверие.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Процессуальная ошибка, лишившая НТК возможности апелляционного обжалования.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Определение Хабаровского краевого суда от 12.12.2024</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
            </div>

            <!-- Section IV -->
            <div class="timeline-section">
                <div class="timeline-section-header" onclick="toggleTimelineSection(this)">
                    <span>IV. 2025–2026 год: Иск на 2,5 миллиарда и судебные споры</span>
                    <span class="event-count">13 событий</span>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="timeline-section-body">
                    <div class="timeline">

                    <div class="timeline-item vtu" id="event-2025-01-15">
                        <div class="timeline-card">
                            <span class="timeline-date">15 января 2025 г.</span>
                            <div class="timeline-title">Арбитражный суд Хабаровского края взыскивает 309 млн руб. с АО «ВаниноТрансУголь»</div>
                            <div class="timeline-description">
                                Арбитражный суд Хабаровского края вынес решение по делу № А73-8310/2024 о взыскании с АО «ВаниноТрансУголь» 309 483 226,27 рублей в счёт возмещения вреда, причинённого водному объекту (бухта Мучке) в результате загрязнения ледового покрова угольной пылью. Расчёт произведён по Методике № 87 на основании площади загрязнения 14 589,94 кв. м (экспертное заключение № 4 от 23.03.2023).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text"><strong>ПРЕЦЕДЕНТ.</strong> Первое судебное решение о взыскании многомиллионного ущерба за загрязнение льда угольной пылью. Создаёт негативный прецедент для дела ДТУ.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение АС Хабаровского края от 15.01.2025 по делу № А73-8310/2024 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2025-03-11">
                        <div class="timeline-card">
                            <span class="timeline-date">11 марта 2025 г.</span>
                            <div class="timeline-title">Хабаровский краевой суд отказывает АО «НТК» в восстановлении срока</div>
                            <div class="timeline-description">
                                Хабаровский краевой суд окончательно отказал АО «НТК» в восстановлении пропущенного срока на апелляционное обжалование решения Кировского районного суда от 01.10.2024 о законности административного штрафа (дело № 21-436/2025).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Окончательное лишение НТК права на апелляционное обжалование штрафа.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Определение Хабаровского краевого суда от 11.03.2025 об отказе в восстановлении срока (дело № 21-436/2025)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2025-03-26">
                        <div class="timeline-card">
                            <span class="timeline-date">26 марта 2025 г.</span>
                            <div class="timeline-title">Девятый кассационный суд общей юрисдикции отклоняет кассационную жалобу АО «Дальтрансуголь» (дело № 88а-2532/2025)</div>
                            <div class="timeline-description">
                                Судебная коллегия по административным делам 9 КСОЮ (председательствующий Зайцева О.А., судьи Кудрина Я.Г., Ровенко П.А.) отклонила кассационную жалобу АО «Дальтрансуголь» на решение Советско-Гаванского городского суда от 31.05.2024 и апелляционное определение Хабаровского краевого суда от 06.09.2024. Суд указал, что общество, имея особый экологический статус оператора морских терминалов, в совокупности с презумпцией экологической опасности любой хозяйственной деятельности, несёт повышенную экологическую ответственность. Доводы о том, что угольная пыль не является отходом и что Методика № 87 неприменима, отклонены как направленные на переоценку обстоятельств дела.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text"><strong>ОКОНЧАТЕЛЬНОЕ ПОДТВЕРЖДЕНИЕ</strong> законности предписания № 16-04/26-КНД-П. Три судебные инстанции признали требования Росприроднадзора правомерными.</div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item vtu" id="event-2025-04-08">
                        <div class="timeline-card">
                            <span class="timeline-date">8 апреля 2025 г.</span>
                            <div class="timeline-title">Шестой арбитражный апелляционный суд подтверждает взыскание 309 млн руб. с ВТУ</div>
                            <div class="timeline-description">
                                Шестой арбитражный апелляционный суд оставил без изменения решение АС Хабаровского края от 15.01.2025 о взыскании с АО «ВаниноТрансУголь» 309 483 226,27 рублей. Апелляционная инстанция отклонила доводы ВТУ об отсутствии реального экологического вреда и неверной квалификации угольной пыли.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Апелляционное подтверждение взыскания. Усиливает негативный прецедент.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление 6 ААС от 08.04.2025 по делу № А73-8310/2024 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2025-05-23">
                        <div class="timeline-card">
                            <span class="timeline-date">23 мая 2025 г.</span>
                            <div class="timeline-title">Кировский районный суд снижает штраф для АО «Дальтрансуголь» до 700 000 рублей</div>
                            <div class="timeline-description">
                                Кировский районный суд г. Хабаровска при рассмотрении жалобы АО «Дальтрансуголь» снизил размер административного штрафа с 1 000 000 до 700 000 рублей, удалив из состава отягчающие обстоятельства (дело № 12-994/2025).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Частичный успех в административном споре. Снижение штрафа на 30%.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Кировского районного суда г. Хабаровска от 23.05.2025 по делу № 12-994/2025</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item vtu critical" id="event-2025-07-09">
                        <div class="timeline-card">
                            <span class="timeline-date">9 июля 2025 г.</span>
                            <div class="timeline-title">Арбитражный суд Дальневосточного округа подтверждает взыскание 309 млн руб. с ВТУ</div>
                            <div class="timeline-description">
                                Арбитражный суд Дальневосточного округа отклонил кассационную жалобу АО «ВаниноТрансУголь» по делу № А73-8310/2024, окончательно подтвердив взыскание 309 483 226,27 рублей в счёт возмещения вреда водному объекту. Суд кассационной инстанции согласился с выводами нижестоящих судов о доказанности факта загрязнения и правильности применения Методики № 87.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text"><strong>ОКОНЧАТЕЛЬНЫЙ ПРЕЦЕДЕНТ.</strong> Три инстанции подтвердили взыскание ущерба за загрязнение льда угольной пылью. Ключевой негативный прецедент для дела ДТУ.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Постановление АС Дальневосточного округа от 09.07.2025 по делу № А73-8310/2024 (ВТУ)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item negative" id="event-2025-08-27">
                        <div class="timeline-card">
                            <span class="timeline-date">27 августа 2025 г.</span>
                            <div class="timeline-title">Хабаровский краевой суд отменяет решение о снижении штрафа</div>
                            <div class="timeline-description">
                                Хабаровский краевой суд отменил решение Кировского районного суда от 23.05.2025 о снижении штрафа для АО «Дальтрансуголь» до 700 000 рублей (дело № 21-1624/2025). Основание: в материалах дела отсутствовали ключевые доказательства, на которые ссылался районный судья при принятии решения.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Отмена благоприятного решения и направление дела на новое рассмотрение.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Хабаровского краевого суда от 27.08.2025 по делу № 21-1624/2025</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2025-10-16">
                        <div class="timeline-card">
                            <span class="timeline-date">16 октября 2025 г.</span>
                            <div class="timeline-title">Кировский районный суд повторно снижает штраф для АО «Дальтрансуголь» до 700 000 рублей и исключает указание на отягчающие обстоятельства</div>
                            <div class="timeline-description">
                                При новом рассмотрении (в ином составе суда) Кировский районный суд г. Хабаровска вновь снизил размер административного штрафа для АО «Дальтрансуголь» до 700 000 рублей и исключил указание на отягчающие обстоятельства.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Повторное снижение штрафа при новом рассмотрении.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Решение Кировского районного суда г. Хабаровска от 16.10.2025</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2025-10-17">
                        <div class="timeline-card">
                            <span class="timeline-date">17 октября 2025 г.</span>
                            <div class="timeline-title">Письмо Росприроднадзора о добровольном возмещении вреда</div>
                            <div class="timeline-description">
                                Росприроднадзор направил АО «Дальтрансуголь» претензионное письмо № 18-10/17190 с требованием о добровольном возмещении вреда, причинённого водному объекту, в размере 2 562 113 054,91 рублей в тридцатидневный срок. Расчёт произведён по п. 16 Методики № 87 (загрязнение мусором и отходами производства).
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Начало гражданско-правового спора о возмещении экологического вреда.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Претензионное письмо Росприроднадзора от 17.10.2025 № 18-10/17190</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item key" id="event-2025-11-19">
                        <div class="timeline-card">
                            <span class="timeline-date">19 ноября 2025 г.</span>
                            <div class="timeline-title">Росприроднадзор подаёт исковое заявление в Арбитражный суд</div>
                            <div class="timeline-description">
                                Приамурское межрегиональное управление Росприроднадзора подало исковое заявление в Арбитражный суд Хабаровского края о взыскании с АО «Дальтрансуголь» возмещения вреда водному объекту в размере 2 562 113 054,91 рублей (дело № А73-19604/2025). Расчёт основан на: площади загрязнения 118 463,33 кв. м; коэффициенте загрязнения 6 (максимальный); таксе 0,8 тыс. руб./кв. м.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Возбуждение дела о взыскании многомиллиардного ущерба.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Исковое заявление Росприроднадзора от 19.11.2025 (дело № А73-19604/2025)</li>
                                    <li><a href="https://kad.arbitr.ru/Card/b4b055cb-7a08-46c2-a750-e7ea083cd905" target="_blank" rel="noopener noreferrer">Карточка дела № А73-19604/2025 в КАД Арбитр</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item positive" id="event-2025-12-10">
                        <div class="timeline-card">
                            <span class="timeline-date">10 декабря 2025 г.</span>
                            <div class="timeline-title">Ответ Министерства транспорта РФ об отсутствии технологий очистки льда</div>
                            <div class="timeline-description">
                                Министерство транспорта Российской Федерации в ответ на запрос АО «Портовый Альянс» (письмо № Д5/2807-ИС) подтвердило, что технологий для очистки ледового покрова водных объектов от угольной пыли в настоящее время не существует.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Подтверждение объективной невозможности устранения загрязнения ледового покрова. Аргумент в пользу отсутствия вины.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Письмо АО «Портовый Альянс» от 14.11.2025 № 0/147 в Минтранс</li>
                                    <li>Ответ Минтранса от 10.12.2025 № Д5/2807-ИС</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item neutral" id="event-2025-12-23">
                        <div class="timeline-card">
                            <span class="timeline-date">23 декабря 2025 г.</span>
                            <div class="timeline-title">Предварительное судебное заседание в Арбитражном суде Хабаровского края</div>
                            <div class="timeline-description">
                                Состоялось предварительное судебное заседание по делу № А73-19604/2025 (судья Татаринов В.А.). Суд отложил рассмотрение дела до 22 января 2026 года для предоставления сторонами дополнительных экспертных заключений и доказательств. АО «Дальтрансуголь» представило предварительный отзыв на исковое заявление с изложением основных возражений.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Начало активной фазы судебного разбирательства по гражданскому иску.</div>
                            </div>
                            <div class="timeline-docs">
                                <div class="timeline-docs-label">Документы:</div>
                                <ul class="timeline-docs-list">
                                    <li>Определение о предварительном судебном заседании от 24.11.2025</li>
                                    <li>Предварительный отзыв АО «Дальтрансуголь» на исковое заявление</li>
                                    <li><a href="https://kad.arbitr.ru/Card/b4b055cb-7a08-46c2-a750-e7ea083cd905" target="_blank" rel="noopener noreferrer">Карточка дела № А73-19604/2025 в КАД Арбитр</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item upcoming" id="event-2026-01-22">
                        <div class="timeline-card">
                            <span class="timeline-date">22 января 2026 г. <span class="upcoming-badge">Предстоит</span></span>
                            <div class="timeline-title">Предварительное судебное заседание по иску Росприроднадзора</div>
                            <div class="timeline-description">
                                Назначено предварительное судебное заседание по делу № А73-19604/2025 о взыскании с АО «Дальтрансуголь» возмещения вреда водному объекту в размере 2 562 113 054,91 рублей. Судья Татаринов В.А.
                            </div>
                            <div class="timeline-significance">
                                <div class="timeline-significance-label">Значение</div>
                                <div class="timeline-significance-text">Ключевое заседание для представления позиции защиты и экспертных заключений, опровергающих причинение реального экологического вреда.</div>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
            </div>

            </main>
        </div>

        <!-- Footer -->
        <footer class="timeline-footer">
            <p>Разработчик: Кирилл Трубицын</p>
        </footer>
    </div>

    <!-- AI Chat Button -->
    <button class="chat-fab" onclick="toggleChat()" aria-label="Открыть чат с ИИ">
        <span class="badge-notify">AI</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
    </button>

    <!-- AI Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <div class="chat-header-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </div>
            <div class="chat-header-info">
                <div class="chat-header-title">Юридический ИИ-помощник</div>
                <div class="chat-header-subtitle">Дело № А73-19604/2025</div>
            </div>
            <button class="chat-close" onclick="toggleChat()" aria-label="Закрыть чат">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Chat Tabs -->
        <div class="chat-tabs">
            <button class="chat-tab active" onclick="switchTab('chat')" id="tabChat">
                💬 Чат
            </button>
            <button class="chat-tab" onclick="switchTab('saved')" id="tabSaved">
                💾 Сохранённые <span class="chat-tab-badge" id="savedBadge" style="display: none;">0</span>
            </button>
        </div>

        <!-- Chat Tab Content -->
        <div class="chat-tab-content active" id="chatTabContent">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome">
                    <h3>Добро пожаловать!</h3>
                    <p>Я помогу разобраться в материалах дела АО «Дальтрансуголь». Задайте вопрос или выберите тему:</p>
                    <div class="chat-suggestions">
                        <button class="chat-suggestion" onclick="askQuestion('Какие самые сильные аргументы защиты?')">
                            Какие самые сильные аргументы защиты?
                        </button>
                        <button class="chat-suggestion" onclick="askQuestion('Расскажи про постановление КС РФ 56-П')">
                            Расскажи про постановление КС РФ 56-П
                        </button>
                        <button class="chat-suggestion" onclick="askQuestion('Как рассчитывается сумма ущерба?')">
                            Как рассчитывается сумма ущерба?
                        </button>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input
                        type="text"
                        class="chat-input"
                        id="chatInput"
                        placeholder="Задайте вопрос о деле..."
                        onkeypress="handleKeyPress(event)"
                    >
                    <div class="chat-options">
                        <label class="think-longer-toggle" title="Поиск актуальной информации в интернете">
                            <input type="checkbox" id="webSearchToggle">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                                Поиск в сети
                            </span>
                        </label>
                    </div>
                </div>
                <button class="chat-send" onclick="sendMessage()" id="sendButton" aria-label="Отправить">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Saved Tab Content -->
        <div class="chat-tab-content" id="savedTabContent">
            <div class="saved-tab-view" id="savedTabView">
                <div class="saved-empty" id="savedEmpty">
                    <p>💾 Нет сохранённых ответов</p>
                    <p style="font-size: 0.8rem; margin-top: 0.5rem;">Нажмите кнопку "Сохранить" под ответом, чтобы добавить его сюда</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Main Page Tab Switching ==========
        function switchMainTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            if (tabName === 'analysis') {
                document.getElementById('mainTabAnalysis').classList.add('active');
                document.getElementById('analysisContent').classList.add('active');
            } else if (tabName === 'timeline') {
                document.getElementById('mainTabTimeline').classList.add('active');
                document.getElementById('timelineContent').classList.add('active');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== Timeline Accordion Functions ==========
        function toggleTimelineSection(header) {
            const section = header.closest('.timeline-section');
            section.classList.toggle('collapsed');
        }

        // ========== Timeline Filter Function ==========
        function filterTimeline(filterType) {
            // Update active button
            document.querySelectorAll('.timeline-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.timeline-filter-btn[data-filter="${filterType}"]`).classList.add('active');

            // Get all timeline items
            const items = document.querySelectorAll('.timeline-item');

            items.forEach(item => {
                if (filterType === 'all') {
                    item.classList.remove('filtered-out');
                } else {
                    // Check if item has the filter class
                    if (item.classList.contains(filterType)) {
                        item.classList.remove('filtered-out');
                    } else {
                        item.classList.add('filtered-out');
                    }
                }
            });

            // Expand all sections when filtering to show results
            if (filterType !== 'all') {
                document.querySelectorAll('.timeline-section').forEach(section => {
                    section.classList.remove('collapsed');
                });
            }

            // Update section event counts
            updateSectionCounts();
        }

        function updateSectionCounts() {
            document.querySelectorAll('.timeline-section').forEach(section => {
                const visibleItems = section.querySelectorAll('.timeline-item:not(.filtered-out)').length;
                const countEl = section.querySelector('.event-count');
                if (countEl) {
                    const word = getEventWord(visibleItems);
                    countEl.textContent = `${visibleItems} ${word}`;
                }
            });
        }

        function getEventWord(n) {
            if (n % 10 === 1 && n % 100 !== 11) return 'событие';
            if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20)) return 'события';
            return 'событий';
        }

        function toggleTimelineItem(header) {
            const item = header.closest('.timeline-item');
            item.classList.toggle('collapsed');

            // Update toggle text
            const toggleSpan = header.querySelector('.timeline-card-toggle span');
            if (toggleSpan) {
                toggleSpan.textContent = item.classList.contains('collapsed') ? 'Показать' : 'Скрыть';
            }
        }

        // ========== Auto-convert timeline items to accordions ==========
        function initTimelineAccordions() {
            document.querySelectorAll('.timeline-item').forEach(item => {
                const card = item.querySelector('.timeline-card');
                if (!card) return;

                // Skip if already has accordion structure
                if (card.querySelector('.timeline-card-header')) return;

                const dateEl = card.querySelector('.timeline-date');
                const titleEl = card.querySelector('.timeline-title');
                const descEl = card.querySelector('.timeline-description');
                const sigEl = card.querySelector('.timeline-significance');
                const docsEl = card.querySelector('.timeline-docs');

                // Only convert if has substantial content (description or docs)
                if (!descEl && !docsEl) return;

                // Create header
                const header = document.createElement('div');
                header.className = 'timeline-card-header';
                header.onclick = function() { toggleTimelineItem(this); };

                // Move date and title to header
                if (dateEl) header.appendChild(dateEl);
                if (titleEl) header.appendChild(titleEl);

                // Add toggle button
                const toggle = document.createElement('div');
                toggle.className = 'timeline-card-toggle';
                toggle.innerHTML = `
                    <span>Подробнее</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                `;
                header.appendChild(toggle);

                // Create body
                const body = document.createElement('div');
                body.className = 'timeline-card-body';

                // Move content to body
                if (descEl) body.appendChild(descEl);
                if (sigEl) body.appendChild(sigEl);
                if (docsEl) body.appendChild(docsEl);

                // Rebuild card
                card.innerHTML = '';
                card.appendChild(header);
                card.appendChild(body);

                // Start collapsed
                item.classList.add('collapsed');
            });
        }

        // Reverse timeline sections order (newest first)
        function reverseTimelineSections() {
            const main = document.querySelector('.timeline-main');
            if (!main) return;

            const sections = Array.from(main.querySelectorAll('.timeline-section'));
            sections.reverse().forEach(section => main.appendChild(section));

            // Expand first section (newest events)
            const firstSection = main.querySelector('.timeline-section');
            if (firstSection) {
                firstSection.classList.remove('collapsed');
            }
        }

        // Reverse events within each section (newest first)
        function reverseEventsInSections() {
            document.querySelectorAll('.timeline-section .timeline').forEach(timeline => {
                const items = Array.from(timeline.querySelectorAll('.timeline-item'));
                items.reverse().forEach(item => timeline.appendChild(item));
            });
        }

        // Reverse calendar years order (newest first)
        function reverseCalendarYears() {
            const container = document.querySelector('.calendar-years');
            if (!container) return;

            const years = Array.from(container.querySelectorAll('.calendar-year'));
            years.reverse().forEach(year => container.appendChild(year));

            // Also reverse events within each year
            container.querySelectorAll('.calendar-year-events').forEach(eventsContainer => {
                const events = Array.from(eventsContainer.querySelectorAll('.calendar-event'));
                events.reverse().forEach(event => eventsContainer.appendChild(event));
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTimelineAccordions();
            reverseTimelineSections();
            reverseEventsInSections();
            reverseCalendarYears();
        });

        // ========== Calendar Navigation Functions ==========
        function toggleCalendarYear(header) {
            const year = header.closest('.calendar-year');
            year.classList.toggle('collapsed');
        }

        function scrollToEvent(eventId) {
            const event = document.getElementById(eventId);
            if (event) {
                // Expand parent section if collapsed
                const section = event.closest('.timeline-section');
                if (section && section.classList.contains('collapsed')) {
                    section.classList.remove('collapsed');
                }

                // Expand the event itself if it has collapsible content
                if (event.classList.contains('collapsed')) {
                    event.classList.remove('collapsed');
                    const toggleSpan = event.querySelector('.timeline-card-toggle span');
                    if (toggleSpan) {
                        toggleSpan.textContent = 'Скрыть';
                    }
                }

                // Scroll to event with offset for sticky header
                setTimeout(() => {
                    const yOffset = -100;
                    const y = event.getBoundingClientRect().top + window.pageYOffset + yOffset;
                    window.scrollTo({ top: y, behavior: 'smooth' });

                    // Highlight the event
                    event.classList.add('highlighted');
                    setTimeout(() => event.classList.remove('highlighted'), 2000);
                }, 150);
            }
        }

        function toggleCard(card) {
            card.classList.toggle('expanded');
        }

        // Expand first card by default
        document.addEventListener('DOMContentLoaded', function() {
            const firstCard = document.querySelector('.card');
            if (firstCard) {
                firstCard.classList.add('expanded');
            }
        });

        // ========== AI Chat Functionality ==========

        const API_URL = '/api/chat'; // Vercel API route
        let isLoading = false;
        let conversationHistory = [];

        // App content context for AI
        const APP_CONTEXT = `
=== ХРОНОЛОГИЯ ДЕЛА 2025-2026 ===

11 марта 2025 — Хабаровский краевой суд отказывает АО «НТК» в восстановлении срока на апелляцию.

23 мая 2025 — Кировский районный суд снижает штраф ДТУ с 1 000 000 до 700 000 рублей.

27 августа 2025 — Хабаровский краевой суд отменяет решение о снижении штрафа, направляет дело на новое рассмотрение.

16 октября 2025 — Кировский районный суд повторно снижает штраф ДТУ до 700 000 рублей.

17 октября 2025 — Росприроднадзор направляет письмо № 18-10/17190 о добровольном возмещении вреда в размере 2 562 113 054,91 руб.

19 ноября 2025 — Росприроднадзор подаёт иск в Арбитражный суд Хабаровского края (дело № А73-19604/2025) о взыскании 2 562 113 054,91 руб. (2,5 млрд руб.) за вред водному объекту.

10 декабря 2025 — Минтранс подтверждает: технологий очистки ледового покрова от угольной пыли не существует (письмо № Д5/2807-ИС).

23 декабря 2025 — Предварительное судебное заседание по делу № А73-19604/2025, отложено до 22 января 2026 г.

22 января 2026 — Назначено судебное заседание (предстоящее).

=== ЛИНИИ ЗАЩИТЫ (краткая сводка) ===

1. Позиция КС РФ (Постановление № 56-П от 06.12.2024) — сила 9/10: Суд обязан учитывать обстоятельства, исключающие или уменьшающие вред. Формальное применение методик недопустимо.

2. Отсутствие реального вреда — сила 8/10: Мониторинг ДВФУ 2008-2024 подтверждает здоровое состояние экосистемы бухты Мучке.

3. Зачёт экологических инвестиций — сила 6/10: Инвестиции 2 047 545 642 руб. в пылеподавление по п.14 Методики 87.

4. Оспаривание методики — сила 5/10: Некорректное применение Кзагр=6 для диффузного загрязнения.

5. Соблюдение нормативов выбросов — сила 5/10: Превышений ПДК не установлено, плата НВОС вносится.

6. Квалификация угольной пыли — сила 4/10: Угольная пыль в перечне веществ для воздуха, не отход по ФККО.

7. Процедурные нарушения — сила 2/10: Проверка согласована с ненадлежащей прокуратурой. НЕ РЕКОМЕНДУЕТСЯ использовать.
`;

        function toggleChat() {
            const modal = document.getElementById('chatModal');
            modal.classList.toggle('open');
            if (modal.classList.contains('open')) {
                // Не фокусироваться на мобильных устройствах, чтобы не открывать клавиатуру
                if (window.innerWidth > 768) {
                    document.getElementById('chatInput').focus();
                }
                updateSavedBadge();
            }
        }

        function switchTab(tab) {
            const chatTab = document.getElementById('tabChat');
            const savedTab = document.getElementById('tabSaved');
            const chatContent = document.getElementById('chatTabContent');
            const savedContent = document.getElementById('savedTabContent');

            if (tab === 'chat') {
                chatTab.classList.add('active');
                savedTab.classList.remove('active');
                chatContent.classList.add('active');
                savedContent.classList.remove('active');
                // Не фокусироваться на мобильных устройствах
                if (window.innerWidth > 768) {
                    document.getElementById('chatInput').focus();
                }
            } else {
                chatTab.classList.remove('active');
                savedTab.classList.add('active');
                chatContent.classList.remove('active');
                savedContent.classList.add('active');
                renderSavedResponses();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        // Saved responses storage
        let savedResponses = JSON.parse(localStorage.getItem('savedResponses') || '[]');

        function addMessage(content, role, sourcesHtml = '') {
            const messagesContainer = document.getElementById('chatMessages');

            // Remove welcome message on first message
            const welcome = messagesContainer.querySelector('.chat-welcome');
            if (welcome) {
                welcome.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = `chat-message-wrapper ${role}`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            // Format message first, then append sources HTML (which bypasses escaping)
            messageDiv.innerHTML = formatMessage(content) + sourcesHtml;
            wrapper.appendChild(messageDiv);

            // Add save button for assistant messages
            if (role === 'assistant') {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-btn';
                saveBtn.innerHTML = '💾 Сохранить';
                saveBtn.onclick = () => saveResponse(content, saveBtn);
                wrapper.appendChild(saveBtn);
            }

            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function saveResponse(content, btn) {
            const timestamp = new Date().toLocaleString('ru-RU');

            savedResponses.push({ content, timestamp, id: Date.now() });
            localStorage.setItem('savedResponses', JSON.stringify(savedResponses));

            btn.innerHTML = '✓ Сохранено';
            btn.classList.add('saved');
            btn.disabled = true;

            updateSavedBadge();
        }

        function updateSavedBadge() {
            const badge = document.getElementById('savedBadge');
            if (savedResponses.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = savedResponses.length;
            } else {
                badge.style.display = 'none';
            }
        }

        function renderSavedResponses() {
            const view = document.getElementById('savedTabView');
            const empty = document.getElementById('savedEmpty');

            if (savedResponses.length === 0) {
                empty.style.display = 'block';
                // Remove all cards
                view.querySelectorAll('.saved-card').forEach(c => c.remove());
                return;
            }

            empty.style.display = 'none';

            // Clear existing cards
            view.querySelectorAll('.saved-card').forEach(c => c.remove());

            // Render cards (newest first)
            [...savedResponses].reverse().forEach((item, idx) => {
                const realIndex = savedResponses.length - 1 - idx;
                const card = document.createElement('div');
                card.className = 'saved-card';
                card.innerHTML = `
                    <div class="saved-card-header">
                        <span class="saved-card-date">${item.timestamp}</span>
                        <div class="saved-card-actions">
                            <button class="saved-card-btn" onclick="exportToDocx(${realIndex})" title="Экспорт в DOCX">📄</button>
                            <button class="saved-card-btn" onclick="copySaved(${realIndex})" title="Копировать">📋</button>
                            <button class="saved-card-btn delete" onclick="deleteSaved(${realIndex})" title="Удалить">🗑️</button>
                        </div>
                    </div>
                    <div class="saved-card-content" id="savedContent${realIndex}">${formatMessage(item.content)}</div>
                    <button class="saved-card-expand" onclick="toggleSavedExpand(${realIndex})">Показать полностью</button>
                `;
                view.appendChild(card);
            });
        }

        function toggleSavedExpand(index) {
            const content = document.getElementById('savedContent' + index);
            content.classList.toggle('expanded');
            const btn = content.nextElementSibling;
            btn.textContent = content.classList.contains('expanded') ? 'Свернуть' : 'Показать полностью';
        }

        function copySaved(index) {
            const item = savedResponses[index];
            if (item) {
                navigator.clipboard.writeText(item.content).then(() => {
                    alert('Скопировано в буфер обмена!');
                });
            }
        }

        function deleteSaved(index) {
            if (confirm('Удалить сохранённый ответ?')) {
                savedResponses.splice(index, 1);
                localStorage.setItem('savedResponses', JSON.stringify(savedResponses));
                updateSavedBadge();
                renderSavedResponses();
            }
        }

        // Экспорт в DOCX
        async function exportToDocx(index) {
            const item = savedResponses[index];
            if (!item) return;

            // Убираем источники из контента
            let content = item.content;
            // Удаляем блок источников (если есть в тексте)
            content = content.replace(/\n*=== ДОКУМЕНТЫ ИЗ БАЗЫ ЗНАНИЙ[\s\S]*?=== КОНЕЦ ДОКУМЕНТОВ ===/g, '');
            content = content.replace(/\n*\[ДОКУМЕНТЫ ИЗ БАЗЫ ЗНАНИЙ:.*?\]/g, '');

            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

            // Парсим контент в параграфы
            const paragraphs = [];

            // Заголовок документа
            paragraphs.push(
                new Paragraph({
                    children: [
                        new TextRun({
                            text: 'Юридическая справка',
                            bold: true,
                            size: 40,  // 20pt
                            color: '1a365d'
                        })
                    ],
                    heading: HeadingLevel.HEADING_1,
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 }
                })
            );

            // Дело и дата
            paragraphs.push(
                new Paragraph({
                    children: [
                        new TextRun({
                            text: `Дело № А73-19604/2025 • ${item.timestamp}`,
                            italics: true,
                            size: 22,  // 11pt
                            color: '666666'
                        })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 400 }
                })
            );

            // Разделитель
            paragraphs.push(
                new Paragraph({
                    children: [new TextRun({ text: '─'.repeat(60), color: 'cccccc', size: 22 })],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 }
                })
            );

            // Разбиваем контент на строки и форматируем
            const lines = content.split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) {
                    paragraphs.push(new Paragraph({ spacing: { after: 100 } }));
                    continue;
                }

                // Заголовки (## или ###)
                if (trimmed.startsWith('### ')) {
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({ text: trimmed.slice(4), bold: true, size: 28 })],  // 14pt
                        heading: HeadingLevel.HEADING_3,
                        spacing: { before: 200, after: 100 }
                    }));
                } else if (trimmed.startsWith('## ')) {
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({ text: trimmed.slice(3), bold: true, size: 28 })],  // 14pt
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 200, after: 100 }
                    }));
                }
                // Списки (* или -)
                else if (trimmed.match(/^[\*\-•] /)) {
                    const text = trimmed.replace(/^[\*\-•] /, '');
                    paragraphs.push(new Paragraph({
                        children: [
                            new TextRun({ text: '• ', bold: true, color: '1a365d', size: 22 }),
                            ...parseInlineFormatting(text, 22)
                        ],
                        indent: { left: 400 },
                        alignment: AlignmentType.JUSTIFIED,
                        spacing: { after: 80 }
                    }));
                }
                // Нумерованные списки
                else if (trimmed.match(/^\d+\. /)) {
                    const match = trimmed.match(/^(\d+)\. (.*)$/);
                    if (match) {
                        paragraphs.push(new Paragraph({
                            children: [
                                new TextRun({ text: `${match[1]}. `, bold: true, color: '1a365d', size: 22 }),
                                ...parseInlineFormatting(match[2], 22)
                            ],
                            indent: { left: 400 },
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 80 }
                        }));
                    }
                }
                // Обычный текст
                else {
                    paragraphs.push(new Paragraph({
                        children: parseInlineFormatting(trimmed, 22),
                        alignment: AlignmentType.JUSTIFIED,
                        spacing: { after: 120 }
                    }));
                }
            }

            // Создаём документ
            const doc = new Document({
                sections: [{
                    properties: {
                        page: {
                            margin: { top: 1440, right: 1000, bottom: 1440, left: 1440 }
                        }
                    },
                    children: paragraphs
                }]
            });

            // Генерируем и скачиваем
            const blob = await Packer.toBlob(doc);
            const filename = `DTU_справка_${new Date().toISOString().slice(0,10)}.docx`;
            saveAs(blob, filename);
        }

        // Парсинг inline форматирования (**bold**, *italic*)
        function parseInlineFormatting(text, fontSize = 22) {
            const runs = [];
            // Паттерн для **bold** и *italic*
            const regex = /(\*\*(.+?)\*\*|\*([^*]+)\*|([^*]+))/g;
            let match;

            while ((match = regex.exec(text)) !== null) {
                if (match[2]) {
                    // **bold**
                    runs.push(new docx.TextRun({ text: match[2], bold: true, size: fontSize }));
                } else if (match[3]) {
                    // *italic*
                    runs.push(new docx.TextRun({ text: match[3], italics: true, size: fontSize }));
                } else if (match[4]) {
                    // plain text
                    runs.push(new docx.TextRun({ text: match[4], size: fontSize }));
                }
            }

            return runs.length > 0 ? runs : [new docx.TextRun({ text, size: fontSize })];
        }

        function formatMessage(content) {
            // Enhanced markdown formatting
            let html = content;

            // Escape HTML first
            html = html.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // LaTeX block formulas $$...$$ -> styled formula block
            html = html.replace(/\$\$([^$]+)\$\$/g, '<div class="formula">$1</div>');

            // LaTeX inline formulas $...$ -> styled inline formula
            html = html.replace(/\$([^$\n]+)\$/g, '<code class="formula-inline">$1</code>');

            // Headers (### Header)
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');

            // Bold (**text**)
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Italic (*text*)
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');

            // Bullet lists (* item or - item)
            html = html.replace(/^[\*\-] (.+)$/gm, '<li>$1</li>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Numbered lists (1. item)
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // Paragraphs (double newline)
            html = html.replace(/\n\n/g, '</p><p>');

            // Single newlines (but not after block elements)
            html = html.replace(/(?<!<\/h3>|<\/ul>|<\/li>|<\/p>)\n(?!<)/g, '<br>');

            // Clean up extra <br> after block elements
            html = html.replace(/<\/h3><br>/g, '</h3>');
            html = html.replace(/<\/ul><br>/g, '</ul>');

            // Wrap in paragraph if not starting with block element
            if (!html.startsWith('<h3>') && !html.startsWith('<ul>') && !html.startsWith('<p>')) {
                html = '<p>' + html + '</p>';
            }

            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');

            return html;
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function showError(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chat-error';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function toggleSources(id, btn) {
            const list = document.getElementById(id);
            list.classList.toggle('open');
            btn.classList.toggle('open');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const webSearchToggle = document.getElementById('webSearchToggle');
            const message = input.value.trim();

            if (!message || isLoading) return;

            isLoading = true;
            sendButton.disabled = true;
            input.value = '';

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            showTyping();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10), // Last 10 messages for context
                        appContext: APP_CONTEXT, // App content for AI context
                        webSearch: webSearchToggle?.checked || false // Web search toggle
                    }),
                });

                hideTyping();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                let responseContent = data.response;

                // Build sources HTML as collapsible accordion
                let sourcesHtml = '';
                if (data.sources && data.sources.length > 0) {
                    const sourcesList = data.sources.map(s => `<li>📄 ${s}</li>`).join('');
                    const sourcesId = 'sources_' + Date.now();
                    sourcesHtml = `
                        <div class="sources">
                            <button class="sources-toggle" onclick="toggleSources('${sourcesId}', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                                📚 Документы из базы знаний (${data.sources.length})
                            </button>
                            <ul class="sources-list" id="${sourcesId}">${sourcesList}</ul>
                        </div>`;
                }

                // Add web sources if available
                if (data.webSources && data.webSources.length > 0) {
                    const webSourcesList = data.webSources.map(s =>
                        `<a href="${s.url}" target="_blank" rel="noopener">🔗 ${s.title}</a>`
                    ).join('');
                    const webSourcesId = 'webSources_' + Date.now();
                    sourcesHtml += `
                        <div class="web-sources">
                            <button class="web-sources-toggle" onclick="toggleSources('${webSourcesId}', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                                🌐 Веб-источники (${data.webSources.length})
                            </button>
                            <div class="web-sources-list" id="${webSourcesId}">${webSourcesList}</div>
                        </div>`;
                }

                addMessage(responseContent, 'assistant', sourcesHtml);
                conversationHistory.push({ role: 'assistant', content: data.response });

            } catch (error) {
                hideTyping();
                console.error('Chat error:', error);
                showError('Не удалось получить ответ. Проверьте подключение к серверу.');
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        // ========== Admin Panel Functionality ==========

        let adminPassword = null;

        function toggleAdmin() {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('open');
            if (modal.classList.contains('open')) {
                if (adminPassword) {
                    document.getElementById('docTitle').focus();
                } else {
                    document.getElementById('adminPassword').focus();
                }
            }
        }

        function closeAdminOnBackdrop(event) {
            if (event.target.id === 'adminModal') {
                toggleAdmin();
            }
        }

        function handleAdminKeyPress(event) {
            if (event.key === 'Enter') {
                adminLogin();
            }
        }

        function showAdminMessage(message, type) {
            const msgDiv = document.getElementById('adminMessage');
            msgDiv.innerHTML = `<div class="admin-message ${type}">${message}</div>`;
            setTimeout(() => {
                msgDiv.innerHTML = '';
            }, 5000);
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;

            if (!password) {
                showAdminMessage('Введите пароль', 'error');
                return;
            }

            // Store password for API calls
            adminPassword = password;

            // Switch to upload form
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminUploadForm').style.display = 'block';
            document.getElementById('adminTitle').textContent = 'Панель администратора';
            document.getElementById('adminPassword').value = '';

            // Load documents count
            loadDocuments();
        }

        function adminLogout() {
            adminPassword = null;
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminUploadForm').style.display = 'none';
            document.getElementById('adminTitle').textContent = 'Вход администратора';
            clearUploadForm();
        }

        function clearUploadForm() {
            document.getElementById('docTitle').value = '';
            document.getElementById('docContent').value = '';
            document.getElementById('docSource').value = '';
            document.getElementById('docCategory').value = 'документ';
            clearFile();
        }

        async function uploadDocument() {
            const title = document.getElementById('docTitle').value.trim();
            const content = document.getElementById('docContent').value.trim();
            const source = document.getElementById('docSource').value.trim();
            const category = document.getElementById('docCategory').value;
            const uploadBtn = document.getElementById('uploadBtn');

            if (!title || !content) {
                showAdminMessage('Заполните название и содержимое документа', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Загрузка...';

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: adminPassword,
                        title,
                        content,
                        source,
                        category
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showAdminMessage('Неверный пароль', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error(data.error || 'Ошибка загрузки');
                }

                showAdminMessage(data.message, 'success');
                clearUploadForm();
                // Refresh document list
                loadDocuments();

            } catch (error) {
                console.error('Upload error:', error);
                showAdminMessage(error.message || 'Ошибка загрузки документа', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Загрузить документ в базу знаний';
            }
        }

        // ========== Document Management ==========

        let currentPage = 1;
        const docsPerPage = 20;

        function switchAdminTab(tab) {
            const uploadTab = document.getElementById('adminTabUpload');
            const docsTab = document.getElementById('adminTabDocuments');
            const uploadContent = document.getElementById('adminUploadTabContent');
            const docsContent = document.getElementById('adminDocsTabContent');

            if (tab === 'upload') {
                uploadTab.classList.add('active');
                docsTab.classList.remove('active');
                uploadContent.classList.add('active');
                docsContent.classList.remove('active');
            } else {
                uploadTab.classList.remove('active');
                docsTab.classList.add('active');
                uploadContent.classList.remove('active');
                docsContent.classList.add('active');
                loadDocuments();
            }
        }

        async function loadDocuments() {
            const docList = document.getElementById('docList');
            const category = document.getElementById('docFilterCategory').value;

            docList.innerHTML = '<div class="doc-loading">Загрузка документов...</div>';

            try {
                const params = new URLSearchParams({
                    password: adminPassword,
                    page: currentPage,
                    limit: docsPerPage,
                    category: category
                });

                const response = await fetch(`/api/documents?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showAdminMessage('Сессия истекла', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error(data.error);
                }

                // Update counts
                document.getElementById('totalDocsCount').textContent = data.total;
                document.getElementById('docCountBadge').textContent = data.total;

                // Render documents
                if (data.documents.length === 0) {
                    docList.innerHTML = '<div class="doc-empty">Документы не найдены</div>';
                } else {
                    docList.innerHTML = data.documents.map(doc => renderDocItem(doc)).join('');
                }

                // Update pagination
                const totalPages = Math.ceil(data.total / docsPerPage);
                const pagination = document.getElementById('docPagination');
                if (totalPages > 1) {
                    pagination.style.display = 'flex';
                    document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
                    document.getElementById('prevPageBtn').disabled = currentPage === 1;
                    document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
                } else {
                    pagination.style.display = 'none';
                }

            } catch (error) {
                console.error('Load documents error:', error);
                docList.innerHTML = '<div class="doc-empty">Ошибка загрузки документов</div>';
            }
        }

        function renderDocItem(doc) {
            const date = doc.created_at ? new Date(doc.created_at).toLocaleDateString('ru-RU') : '';
            const categoryLabels = {
                'документ': 'Документ',
                'договор': 'Договор',
                'акт': 'Акт',
                'переписка': 'Переписка',
                'заключение': 'Заключение',
                'судебный_акт': 'Судебный акт',
                'процессуальный_документ': 'Процессуальный док.',
                'нормативный_акт': 'Норм. акт',
                'отчет': 'Отчёт',
                'справка_ии': 'Справка ИИ'
            };

            return `
                <div class="doc-item">
                    <div class="doc-item-info">
                        <div class="doc-item-title" title="${escapeHtml(doc.title)}">${escapeHtml(doc.title)}</div>
                        <div class="doc-item-meta">
                            <span class="doc-item-category">${categoryLabels[doc.category] || doc.category}</span>
                            ${date ? `<span>${date}</span>` : ''}
                        </div>
                    </div>
                    <div class="doc-item-actions">
                        <button class="doc-item-btn" onclick="editDocument('${doc.id}')" title="Редактировать">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="doc-item-btn delete" onclick="deleteDocument('${doc.id}', '${escapeHtml(doc.title)}')" title="Удалить">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function changePage(delta) {
            currentPage += delta;
            loadDocuments();
        }

        // Documents cache for editing
        let documentsCache = {};

        async function editDocument(id) {
            try {
                // Fetch document data
                const params = new URLSearchParams({
                    password: adminPassword,
                    page: 1,
                    limit: 1000
                });
                const response = await fetch(`/api/documents?${params}`);
                const data = await response.json();

                const doc = data.documents.find(d => d.id === id);
                if (!doc) {
                    showAdminMessage('Документ не найден', 'error');
                    return;
                }

                // Fill edit form
                document.getElementById('editDocId').value = doc.id;
                document.getElementById('editDocTitle').value = doc.title || '';
                document.getElementById('editDocContent').value = doc.content || '';
                document.getElementById('editDocSource').value = doc.source || '';
                document.getElementById('editDocCategory').value = doc.category || 'документ';

                // Show modal
                document.getElementById('editModal').classList.add('open');

            } catch (error) {
                console.error('Edit document error:', error);
                showAdminMessage('Ошибка загрузки документа', 'error');
            }
        }

        function closeEditModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('editModal').classList.remove('open');
            }
        }

        async function saveDocument() {
            const id = document.getElementById('editDocId').value;
            const title = document.getElementById('editDocTitle').value.trim();
            const content = document.getElementById('editDocContent').value.trim();
            const source = document.getElementById('editDocSource').value.trim();
            const category = document.getElementById('editDocCategory').value;

            if (!title || !content) {
                showAdminMessage('Заполните название и содержимое', 'error');
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        id: id,
                        title,
                        content,
                        source,
                        category
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage('Документ обновлён', 'success');
                closeEditModal();
                loadDocuments();

            } catch (error) {
                console.error('Save document error:', error);
                showAdminMessage(error.message || 'Ошибка сохранения', 'error');
            }
        }

        async function deleteDocument(id, title) {
            if (!confirm(`Удалить документ "${title}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        id: id
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage('Документ удалён', 'success');
                loadDocuments();

            } catch (error) {
                console.error('Delete document error:', error);
                showAdminMessage(error.message || 'Ошибка удаления', 'error');
            }
        }

        async function deleteAllDocuments() {
            const total = document.getElementById('totalDocsCount').textContent;
            if (!confirm(`Вы уверены, что хотите удалить ВСЕ ${total} документов из базы знаний? Это действие нельзя отменить!`)) {
                return;
            }

            if (!confirm('Подтвердите удаление ещё раз. Все данные будут потеряны!')) {
                return;
            }

            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        deleteAll: true
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                showAdminMessage(`Удалено ${data.deletedCount || 'все'} документов`, 'success');
                loadDocuments();

            } catch (error) {
                console.error('Delete all documents error:', error);
                showAdminMessage(error.message || 'Ошибка удаления', 'error');
            }
        }

        // ========== File Upload & OCR Functionality ==========

        let currentFile = null;

        // Initialize drag & drop when admin form is shown
        function initDropZone() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        async function processFile(file) {
            // Определяем тип файла
            const isImage = file.type.startsWith('image/');
            const isPDF = file.type === 'application/pdf';
            const isText = file.name.endsWith('.md') || file.name.endsWith('.txt') || file.type === 'text/plain' || file.type === 'text/markdown';
            const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

            // Validate file type
            if (!isImage && !isPDF && !isText && !isDOCX) {
                showAdminMessage('Поддерживаются: изображения, PDF, DOCX, Markdown (.md), TXT', 'error');
                return;
            }

            // Validate file size (max 20MB for PDF/DOCX, 10MB for others)
            const maxSize = (isPDF || isDOCX) ? 20 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showAdminMessage(`Файл слишком большой. Максимум ${(isPDF || isDOCX) ? '20' : '10'} МБ`, 'error');
                return;
            }

            currentFile = file;
            showFilePreview(file);
            await recognizeDocument(file);
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const previewName = document.getElementById('previewName');
            const previewSize = document.getElementById('previewSize');

            previewName.textContent = file.name;
            previewSize.textContent = formatFileSize(file.size);

            const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // PDF icon
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="7" y="16" font-size="6" fill="#e53e3e" stroke="none">PDF</text></svg>');
            } else if (isDOCX) {
                // DOCX icon (blue)
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2b579a" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="5" y="16" font-size="5" fill="#2b579a" stroke="none">DOCX</text></svg>');
            } else {
                // Text/Markdown icon
                previewImage.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#718096" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>');
            }

            preview.style.display = 'flex';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' Б';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' КБ';
            return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        function updateProcessingText(text) {
            document.getElementById('processingText').textContent = text;
        }

        async function recognizeDocument(file) {
            const dropZone = document.getElementById('dropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');
            const processingIndicator = document.getElementById('processingIndicator');

            // Show processing state
            dropZone.classList.add('processing');
            dropZoneContent.style.display = 'none';
            processingIndicator.style.display = 'flex';
            updateProcessingText('Подготовка файла...');

            try {
                let requestBody;
                const isText = file.name.endsWith('.md') || file.name.endsWith('.txt') || file.type === 'text/plain' || file.type === 'text/markdown';
                const isPDF = file.type === 'application/pdf';
                const isDOCX = file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

                if (isText) {
                    // Текстовые файлы - читаем как текст
                    updateProcessingText('Анализ текстового документа...');
                    const textContent = await readFileAsText(file);
                    requestBody = {
                        password: adminPassword,
                        textContent: textContent,
                        fileType: 'text',
                        fileName: file.name
                    };
                } else if (isDOCX) {
                    // DOCX - извлекаем текст через mammoth.js
                    updateProcessingText('Извлечение текста из DOCX...');
                    const textContent = await extractDocxText(file);
                    requestBody = {
                        password: adminPassword,
                        textContent: textContent,
                        fileType: 'text',
                        fileName: file.name
                    };
                } else if (isPDF) {
                    // PDF - конвертируем все страницы в изображения
                    updateProcessingText('Загрузка PDF...');
                    const images = await convertPdfToImages(file);

                    // Разбиваем на части по 5 страниц для больших PDF
                    const PAGES_PER_BATCH = 5;
                    if (images.length > PAGES_PER_BATCH) {
                        const results = [];
                        const totalBatches = Math.ceil(images.length / PAGES_PER_BATCH);

                        for (let i = 0; i < images.length; i += PAGES_PER_BATCH) {
                            const batch = images.slice(i, i + PAGES_PER_BATCH);
                            const batchNum = Math.floor(i / PAGES_PER_BATCH) + 1;
                            updateProcessingText(`Распознавание ${batchNum}/${totalBatches}...`);

                            const response = await fetch('/api/recognize', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    password: adminPassword,
                                    images: batch,
                                    fileName: file.name
                                }),
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`Ошибка части ${batchNum}: ${errorText.substring(0, 100)}`);
                            }

                            results.push(await response.json());
                        }

                        // Объединяем результаты
                        const combinedContent = results.map(r => r.content || '').join('\n\n');
                        const first = results[0] || {};

                        document.getElementById('docTitle').value = first.title || file.name;
                        document.getElementById('docContent').value = combinedContent;
                        document.getElementById('docSource').value = first.source || file.name;
                        if (first.category) {
                            document.getElementById('docCategory').value = first.category;
                        }

                        showAdminMessage(`Распознано ${images.length} стр! Проверьте данные`, 'success');
                        return;
                    }

                    // Маленький PDF - целиком
                    updateProcessingText(`Распознавание ${images.length} стр...`);
                    requestBody = {
                        password: adminPassword,
                        images: images,
                        fileName: file.name
                    };
                } else {
                    // Изображение
                    updateProcessingText('ИИ распознаёт документ...');
                    const base64 = await fileToBase64(file);
                    requestBody = {
                        password: adminPassword,
                        image: base64,
                        mediaType: file.type,
                        fileName: file.name
                    };
                }

                // Call recognition API
                const bodyStr = JSON.stringify(requestBody);
                console.log('Request size:', (bodyStr.length / 1024 / 1024).toFixed(2), 'MB');

                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: bodyStr,
                });

                // Сначала проверяем статус, потом парсим
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    if (response.status === 401) {
                        showAdminMessage('Неверный пароль', 'error');
                        adminLogout();
                        return;
                    }
                    // Попробуем распарсить как JSON, иначе покажем текст
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || `Ошибка сервера: ${response.status}`);
                    } catch (e) {
                        throw new Error(`Ошибка сервера (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                }

                const data = await response.json();

                // Fill the form with recognized data
                if (data.title) {
                    document.getElementById('docTitle').value = data.title;
                }
                if (data.content) {
                    document.getElementById('docContent').value = data.content;
                }
                if (data.source) {
                    document.getElementById('docSource').value = data.source;
                }
                if (data.category) {
                    const categorySelect = document.getElementById('docCategory');
                    const option = Array.from(categorySelect.options).find(opt => opt.value === data.category);
                    if (option) {
                        categorySelect.value = data.category;
                    }
                }

                showAdminMessage('Документ распознан! Проверьте и отредактируйте данные', 'success');

            } catch (error) {
                console.error('Recognition error:', error);
                showAdminMessage(error.message || 'Ошибка распознавания документа', 'error');
            } finally {
                // Reset drop zone state
                dropZone.classList.remove('processing');
                dropZoneContent.style.display = 'block';
                processingIndicator.style.display = 'none';
                updateProcessingText('ИИ распознаёт документ...');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data URL prefix to get pure base64
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Извлечение текста из DOCX через mammoth.js
        async function extractDocxText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const arrayBuffer = reader.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function convertPdfToImages(file) {
            // Инициализируем PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const numPages = pdf.numPages;
            const images = [];

            // Рендерим каждую страницу
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                updateProcessingText(`Обработка страницы ${pageNum}/${numPages}...`);

                const page = await pdf.getPage(pageNum);
                // Масштаб 1.2 - достаточно для OCR
                const scale = 1.2;
                const viewport = page.getViewport({ scale });

                // Ограничиваем максимальный размер (макс 1200px по большей стороне)
                const maxDimension = 1200;
                let finalScale = scale;
                if (viewport.width > maxDimension || viewport.height > maxDimension) {
                    const ratio = maxDimension / Math.max(viewport.width, viewport.height);
                    finalScale = scale * ratio;
                }
                const finalViewport = page.getViewport({ scale: finalScale });

                // Создаём canvas для рендеринга
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = finalViewport.width;
                canvas.height = finalViewport.height;

                // Рендерим страницу
                await page.render({
                    canvasContext: context,
                    viewport: finalViewport
                }).promise;

                // Конвертируем в JPEG с качеством 0.6 для меньшего размера
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const base64 = dataUrl.split(',')[1];

                images.push({
                    data: base64,
                    mediaType: 'image/jpeg',
                    pageNumber: pageNum
                });
            }

            return images;
        }

        // Initialize drop zone when DOM is ready
        document.addEventListener('DOMContentLoaded', initDropZone);
    </script>

    <!-- Регистрация Service Worker для PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker зарегистрирован:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Ошибка регистрации Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
